<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Lavados Oasis</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* ESTILOS BASE - MISMOS COLORES QUE SUPERVISIÓN */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --insumos-light-gray: #f0f2f5;
        }

        html, body {
            touch-action: manipulation;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--insumos-light-gray);
            color: var(--dark-color);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            text-align: center;
            padding: 18px 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px 50px 15px;
        }

        .card-custom {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: none;
            margin-bottom: 25px;
            border-top: 5px solid var(--secondary-color);
            padding: 20px;
            height: 100%;
        }

        .btn-custom {
            border: none;
            font-weight: 600;
            padding: 10px 25px;
            font-size: 0.95rem;
            border-radius: 50px;
            transition: var(--transition);
            color: white !important;
            background: linear-gradient(45deg, var(--secondary-color), #5dade2);
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-custom:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

        .kpi-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); }
        .kpi-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .kpi-icon { font-size: 2rem; color: var(--secondary-color); margin-bottom: 15px; opacity: 0.8; }

        .chart-box { position: relative; height: 300px; width: 100%; }

        /* DESGLOSE DE CUMPLIMIENTO */
        .desglose-container {
            width: 100%;
        }
        
        .desglose-semana {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .desglose-semana:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .semana-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .semana-titulo {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .semana-estadisticas {
            font-size: 0.9rem;
            color: #666;
        }
        
        .barra-desglose {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            background-color: #f8f9fa;
            margin-bottom: 5px;
        }
        
        .segmento-lavado {
            background-color: var(--success-color);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        /* COLORES PARA MOTIVOS ESPECÍFICOS */
        .segmento-motivo1 { background-color: #e74c3c; } /* Área no disponible */
        .segmento-motivo2 { background-color: #f39c12; } /* Indisponibilidad de agua */
        .segmento-motivo3 { background-color: #3498db; } /* Lavado no realizado por solicitud del cliente */
        .segmento-motivo4 { background-color: #95a5a6; } /* No se hizo el lavado */
        
        .leyenda-motivos {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .item-leyenda {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .color-leyenda {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* TABLA SEMANAL CON HEADER FIJADO */
        .tabla-semanal-container {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        
        .tabla-semanal {
            font-size: 0.85rem;
            margin-bottom: 0;
        }
        
        .tabla-semanal thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--primary-color) !important;
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            padding: 10px 5px;
            border-bottom: 2px solid var(--dark-color);
        }
        
        .tabla-semanal tbody td {
            vertical-align: middle;
            padding: 8px 5px;
            text-align: center;
        }
        
        /* ESTADOS - CELDA COMPLETA EN COLOR */
        .estado-lavado {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        
        /* COLORES PARA MOTIVOS EN CELDAS */
        .estado-motivo1 {
            background-color: #f8d7da !important; /* Área no disponible */
            color: #721c24 !important;
        }
        .estado-motivo2 {
            background-color: #fff3cd !important; /* Indisponibilidad de agua */
            color: #856404 !important;
        }
        .estado-motivo3 {
            background-color: #d1ecf1 !important; /* Lavado no realizado por solicitud del cliente */
            color: #0c5460 !important;
        }
        .estado-motivo4 {
            background-color: #e2e3e5 !important; /* No se hizo el lavado */
            color: #383d41 !important;
        }
        
        /* TOOLTIP PARA MOTIVOS */
        .motivo-tooltip {
            position: relative;
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .motivo-tooltip .motivo-texto {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        
        .motivo-tooltip:hover .motivo-texto {
            visibility: visible;
            opacity: 1;
        }
        
        /* BOTONES DE ACCIÓN - IGUAL QUE LA PÁGINA DE REFERENCIA */
        .btn-action {
            border: none;
            border-radius: 50px;
            width: 35px;
            height: 35px;
            font-size: 0.85rem;
            margin: 0 2px;
            transition: var(--transition);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .btn-action:hover { 
            transform: translateY(-2px); 
            color: white;
        }
        .btn-pdf { 
            background: linear-gradient(45deg, var(--accent-color), #e74c3c); 
        }
        .btn-share { 
            background: linear-gradient(45deg, #1abc9c, #16a085); 
        }
        .btn-download { 
            background: linear-gradient(45deg, #27ae60, #2ecc71); 
        }
        .btn-delete { 
            background: #7f8c8d; 
        }
        .btn-delete:hover { 
            background: #c0392b; 
        }

        /* MODAL PDF FULLSCREEN - IGUAL QUE LA PÁGINA DE REFERENCIA */
        .modal-pdf-body {
            height: calc(100vh - 56px); 
            padding: 0;
            overflow: hidden;
            background-color: #525659;
        }
        .modal-pdf-iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
            display: block; 
        }
        .modal-header { 
            background-color: #f8f9fa; 
            border-bottom: 1px solid #dee2e6; 
            padding: 10px 20px; 
        }
        
/* OVERLAY CARGA - ACTUALIZADO PARA QUE SEA IGUAL A LA PÁGINA DE REFERENCIA */
#overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.95);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(52, 152, 219, 0.2);
    border-radius: 50%;
    border-top-color: var(--secondary-color);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

#loadingMessage {
    text-align: center;
    color: var(--dark-color);
}

#loadingMessage h4 {
    margin: 0 0 10px;
    font-size: 1.3rem;
    font-weight: bold;
}

#loadingMessage p {
    margin: 0;
    color: #7f8c8d;
    font-weight: normal;
}
        
        /* ICONOS CENTRADOS */
        .icono-centrado {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            font-size: 1.2rem;
        }
        
        /* FORMATO PARA SUB-UBICACIONES CON UBICACIÓN PRINCIPAL */
        .sububicacion-con-ubicacion {
            font-size: 0.9rem;
        }
        .texto-ubicacion-principal {
            color: #666;
            font-size: 0.8rem;
        }
        .texto-sububicacion {
            font-weight: 600;
        }
        
        /* CELDAS DE TABLA - ARREGLAR ALTURA */
        .tabla-semanal tbody tr {
            height: 60px;
        }
        
        .tabla-semanal tbody td {
            height: 60px;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <!-- MODAL PDF FULLSCREEN - IGUAL QUE LA PÁGINA DE REFERENCIA -->
    <div class="modal fade" id="modalPDF" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-secondary"><i class="fas fa-file-pdf me-2"></i>Visualizador de Reporte</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-pdf-body">
                    <iframe id="iframePDF" class="modal-pdf-iframe" src=""></iframe>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        Pisos Brillantes
    </div>

    <div class="container-custom">
        
        <!-- Panel de Control -->
        <div class="card-custom">
            <h5 class="mb-3 text-secondary border-bottom pb-2">
                <i class="fas fa-sliders-h me-2"></i>Panel de Control
            </h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Proyecto</label>
                    <select id="filtroProyecto" class="form-select">
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="ARPIA">ARPIA</option>
                        <option value="ARRIO">ARRIO</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Mes</label>
                    <select id="filtroMes" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Año</label>
                    <select id="filtroAnio" class="form-select"></select>
                </div>
                <div class="col-md-2">
                    <button class="btn-custom" onclick="consultarDatosOasis()">
                        <i class="fas fa-search me-1"></i> Consultar
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            
            <!-- KPI Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="kpi-value" id="kpiLavados">0</div>
                        <div class="kpi-label">Oasis Lavados del Mes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="kpi-value" id="kpiNoLavados">0</div>
                        <div class="kpi-label">Oasis No Lavados del Mes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-percentage"></i></div>
                        <div class="kpi-value" id="kpiCumplimiento">0%</div>
                        <div class="kpi-label">Cumplimiento del Mes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="kpi-value" id="kpiCumplimientoAnual">0%</div>
                        <div class="kpi-label">% Cumplimiento Anual</div>
                    </div>
                </div>
            </div>

            <!-- Desglose de Cumplimiento por Semana -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card-custom">
                        <h5 class="mb-3 text-secondary">
                            <i class="fas fa-chart-pie me-2"></i>Desglose de Cumplimiento por Semana
                        </h5>
                        <div id="desgloseContainer" class="desglose-container">
                            <!-- El desglose se generará dinámicamente -->
                        </div>
                        <div class="leyenda-motivos mt-3">
                            <div class="item-leyenda">
                                <div class="color-leyenda" style="background-color: var(--success-color);"></div>
                                <span>Lavados completados</span>
                            </div>
                            <div class="item-leyenda">
                                <div class="color-leyenda" style="background-color: #e74c3c;"></div>
                                <span>Área no disponible</span>
                            </div>
                            <div class="item-leyenda">
                                <div class="color-leyenda" style="background-color: #f39c12;"></div>
                                <span>Indisponibilidad de agua</span>
                            </div>
                            <div class="item-leyenda">
                                <div class="color-leyenda" style="background-color: #3498db;"></div>
                                <span>Lavado no realizado por solicitud del cliente</span>
                            </div>
                            <div class="item-leyenda">
                                <div class="color-leyenda" style="background-color: #95a5a6;"></div>
                                <span>No se hizo el lavado</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartMensual"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Oasis lavados vs no lavados por semana
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartAnual"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tendencia anual de lavados de oasis
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla Semanal CON SUB-UBICACIONES Y HEADER FIJADO -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-secondary mb-0">
                                <i class="fas fa-table me-2"></i>Historial de Lavados de Oasis
                            </h5>
                            <div>
                                <small class="text-muted me-3">
                                    <span class="d-inline-block" style="width: 12px; height: 12px; background-color: #d4edda; border-radius: 2px;"></span> Lavado
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> Pasa el cursor para ver motivo
                                </small>
                            </div>
                        </div>
                        
                        <div class="tabla-semanal-container">
                            <table class="table table-hover tabla-semanal" id="tablaSemanas">
                                <thead>
                                    <tr>
                                        <th style="width: 300px; min-width: 300px; text-align: left;">Ubicación / Sub-Ubicación</th>
                                        <!-- Las columnas de semanas se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tablaSemanasCuerpo">
                                    <!-- El contenido se generará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <div id="alertNoData" class="alert alert-warning text-center mt-4 shadow-sm" style="display:none;">
            <i class="fas fa-info-circle me-2"></i> No existen registros para el mes seleccionado.
        </div>

    </div>

    <script>
        // REEMPLAZA ESTA URL CON LA DE TU GOOGLE APPS SCRIPT
        const URL_SCRIPT_GOOGLE_OASIS = "https://script.google.com/macros/s/AKfycbx5ak6xG-6eKo85TUKb4OJ3t3bkgN-Qui70vYOyuJstS336UQZwuBUHaBgugICxBIo/exec";
        
        // Configuración de sub-ubicaciones por proyecto
        const SUB_UBICACIONES_POR_PROYECTO = {
            "ARPIA": {
                "Administración": [
                    "Compras",
                    "Contabilidad",
                    "CRO",
                    "Ejecutores de Mantenimiento",
                    "Gerencia",
                    "Inspectores de Mantenimiento",
                    "Materias Primas",
                    "Procesos",
                    "Producción",
                    "Profesionales Eléctricos",
                    "Proyectos",
                    "Recursos Humanos",
                    "Sala de Reuniones",
                    "SISO"
                ],
                "Laboratorio de Calidad": [
                    "Ensayo Físico",
                    "Profesionales",
                    "Pasillo de 2ndo Piso"
                ],
                "Posta Principal": [
                    "Guardias",
                    "Recepción"
                ]
            },
            "ARRIO": {}
        };
        
        // Configuración de motivos
        const MOTIVOS = [
            "Área no disponible",
            "Indisponibilidad de agua", 
            "Lavado no realizado por solicitud del cliente",
            "No se hizo el lavado"
        ];
        
        let chartMensual = null;
        let chartAnual = null;
        let datosGlobales = null;
        let proyectoActual = "";
        let modalPDF = null;

        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                             "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function focusPDF() {
            const iframe = document.getElementById('iframePDF');
            if (iframe) {
                iframe.focus();
                try {
                    iframe.contentWindow.focus();
                } catch(e) {
                    // Si falla por seguridad
                }
            }
        }

        window.onload = function() {
            // Inicializar modal PDF
            const modalEl = document.getElementById('modalPDF');
            modalPDF = new bootstrap.Modal(modalEl);
            
            modalEl.addEventListener('shown.bs.modal', function () {
                setTimeout(focusPDF, 100);
            });

            // Configurar filtros de fecha
            const selectMes = document.getElementById('filtroMes');
            mesesNombres.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = (i + 1).toString().padStart(2, '0');
                opt.text = m;
                if(i === new Date().getMonth()) opt.selected = true;
                selectMes.appendChild(opt);
            });

            const selectAnio = document.getElementById('filtroAnio');
            const currentYear = new Date().getFullYear();
            const prevYear = currentYear - 1;
            
            let optPrev = document.createElement('option');
            optPrev.value = prevYear;
            optPrev.text = prevYear;
            selectAnio.appendChild(optPrev);

            let optCurr = document.createElement('option');
            optCurr.value = currentYear;
            optCurr.text = currentYear;
            optCurr.selected = true;
            selectAnio.appendChild(optCurr);
        };

        function showLoading(mensaje, submensaje = "") {
            const overlay = document.getElementById('overlay');
            const msgTitle = document.querySelector('#loadingMessage h4');
            const msgSub = document.querySelector('#loadingMessage p');
            if(msgTitle) msgTitle.textContent = mensaje;
            if(msgSub) msgSub.textContent = submensaje;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('overlay').style.display = 'none';
        }

        function consultarDatosOasis() {
            proyectoActual = document.getElementById('filtroProyecto').value;
            const mesVal = document.getElementById('filtroMes').value;
            const anio = document.getElementById('filtroAnio').value;

            if (!proyectoActual) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Proyecto Requerido',
                    text: 'Por favor, selecciona un proyecto para consultar.'
                });
                return;
            }

            showLoading("Por favor espera un momento...", "Consultando datos de lavados de oasis...");
            
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('alertNoData').style.display = 'none';

            // USANDO LA MISMA TÉCNICA QUE LA PÁGINA DE REFERENCIA
            const requestData = {
                action: "obtenerDatos",
                proyecto: proyectoActual,
                mes: mesVal,
                anio: anio
            };

            // Usar XMLHttpRequest que funciona mejor con Google Apps Script
            const xhr = new XMLHttpRequest();
            xhr.open('POST', URL_SCRIPT_GOOGLE_OASIS, true);
            
            // Importante: Usar 'text/plain' para evitar problemas CORS
            xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
            
            xhr.onload = function() {
                hideLoading();
                try {
                    // Google Apps Script devuelve JSON como string
                    const responseText = xhr.responseText;
                    
                    // Limpiar posible texto extra que Google añade
                    let cleanResponse = responseText;
                    if (cleanResponse.includes('//')) {
                        cleanResponse = cleanResponse.substring(cleanResponse.indexOf('{'));
                    }
                    
                    const data = JSON.parse(cleanResponse);
                    
                    if (data.status === "success") {
                        datosGlobales = data.data;
                        renderizarDashboardOasis(datosGlobales, mesVal, anio);
                        
                        if (!datosGlobales.existeHoja || datosGlobales.totalOasis === 0) {
                            document.getElementById('alertNoData').style.display = 'block';
                        }
                    } else {
                        Swal.fire("Error", data.message || "Error desconocido", "error");
                    }
                } catch (error) {
                    console.error("Error parseando respuesta:", error, "Respuesta:", xhr.responseText);
                    Swal.fire("Error", "Error procesando la respuesta del servidor: " + error.message, "error");
                }
            };
            
            xhr.onerror = function() {
                hideLoading();
                console.error("Error de red en XMLHttpRequest");
                Swal.fire("Error", "Error de conexión con el servidor", "error");
            };
            
            // Enviar como JSON string
            xhr.send(JSON.stringify(requestData));
        }

        function renderizarDashboardOasis(data, mesVal, anio) {
            document.getElementById('dashboardContent').style.display = 'block';
            
            // Actualizar KPI's
            document.getElementById('kpiLavados').textContent = data.oasisLavados;
            document.getElementById('kpiNoLavados').textContent = data.oasisNoLavados;
            document.getElementById('kpiCumplimiento').textContent = `${data.porcentajeCumplimiento}%`;
            
            // Calcular porcentaje de cumplimiento anual
            const porcentajeCumplimientoAnual = calcularPorcentajeCumplimientoAnual(data.datosGraficoAnual);
            document.getElementById('kpiCumplimientoAnual').textContent = `${porcentajeCumplimientoAnual}%`;
            
            const nombreMes = mesesNombres[parseInt(mesVal) - 1];
            
            // Crear gráfico mensual
            const ctxMensual = document.getElementById('chartMensual');
            if (chartMensual) chartMensual.destroy();
            
            chartMensual = new Chart(ctxMensual, {
                type: 'bar',
                data: {
                    labels: data.datosGraficoMensual.labels.map(s => `Sem ${s}`),
                    datasets: [
                        {
                            label: 'Oasis Lavados',
                            data: data.datosGraficoMensual.lavados,
                            backgroundColor: '#27ae60',
                            borderRadius: 4
                        },
                        {
                            label: 'Oasis No Lavados',
                            data: data.datosGraficoMensual.noLavados,
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Lavados por Semana - ${nombreMes} ${anio}`,
                            font: { size: 14 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Semana',
                                font: { weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Oasis',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Crear gráfico anual
            const ctxAnual = document.getElementById('chartAnual');
            if (chartAnual) chartAnual.destroy();
            
            chartAnual = new Chart(ctxAnual, {
                type: 'line',
                data: {
                    labels: data.datosGraficoAnual.labels,
                    datasets: [
                        {
                            label: 'Oasis Lavados',
                            data: data.datosGraficoAnual.lavados,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Oasis No Lavados',
                            data: data.datosGraficoAnual.noLavados,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Tendencia Anual - ${anio}`,
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Oasis',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });

            // Renderizar desglose de cumplimiento
            renderizarDesgloseCumplimiento(data);
            
            // Renderizar tabla semanal con sub-ubicaciones
            renderizarTablaSemanas(data);
        }

        function calcularPorcentajeCumplimientoAnual(datosAnual) {
            let totalLavados = 0;
            let totalGeneral = 0;
            
            for (let i = 0; i < datosAnual.lavados.length; i++) {
                totalLavados += datosAnual.lavados[i];
                totalGeneral += datosAnual.lavados[i] + datosAnual.noLavados[i];
            }
            
            if (totalGeneral === 0) return 0;
            return Math.round((totalLavados / totalGeneral) * 100);
        }

        function renderizarDesgloseCumplimiento(data) {
            const container = document.getElementById('desgloseContainer');
            container.innerHTML = '';
            
            // Primero, procesar los datos para contar por motivo
            const estadisticasPorSemana = {};
            
            Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
                const resumen = data.resumenSemanas[semana];
                
                // Inicializar estadísticas para esta semana
                estadisticasPorSemana[semana] = {
                    lavados: resumen.lavados,
                    noLavados: resumen.noLavados,
                    total: resumen.lavados + resumen.noLavados,
                    porMotivo: {
                        "Área no disponible": 0,
                        "Indisponibilidad de agua": 0,
                        "Lavado no realizado por solicitud del cliente": 0,
                        "No se hizo el lavado": 0,
                        "Otro": 0
                    }
                };
                
                // Contar motivos en los registros de esta semana
                Object.values(resumen.ubicaciones).forEach(ubicacion => {
                    if (!ubicacion.lavado && ubicacion.motivo) {
                        let motivoEncontrado = false;
                        
                        // Buscar si el motivo coincide con alguno de los definidos
                        for (const motivo of MOTIVOS) {
                            if (ubicacion.motivo.toLowerCase().includes(motivo.toLowerCase())) {
                                estadisticasPorSemana[semana].porMotivo[motivo]++;
                                motivoEncontrado = true;
                                break;
                            }
                        }
                        
                        // Si no coincide con ningún motivo definido, contar como "Otro"
                        if (!motivoEncontrado) {
                            estadisticasPorSemana[semana].porMotivo["Otro"]++;
                        }
                    }
                });
            });
            
            // Ahora renderizar cada semana
            Object.keys(estadisticasPorSemana).sort((a, b) => a - b).forEach(semana => {
                const estadisticas = estadisticasPorSemana[semana];
                const porcentajeLavados = estadisticas.total > 0 ? 
                    Math.round((estadisticas.lavados / estadisticas.total) * 100) : 0;
                
                const semanaDiv = document.createElement('div');
                semanaDiv.className = 'desglose-semana';
                
                let contenidoHTML = `
                    <div class="semana-header">
                        <div class="semana-titulo">Semana ${semana}</div>
                        <div class="semana-estadisticas">
                            ${estadisticas.lavados} lavados / ${estadisticas.total} total (${porcentajeLavados}% cumplimiento)
                        </div>
                    </div>
                    <div class="barra-desglose">
                `;
                
                // Agregar segmento de lavados
                if (estadisticas.lavados > 0) {
                    const porcentajeSegmentoLavado = (estadisticas.lavados / estadisticas.total) * 100;
                    contenidoHTML += `
                        <div class="segmento-lavado" style="width: ${porcentajeSegmentoLavado}%" 
                             title="${estadisticas.lavados} lavados (${Math.round(porcentajeSegmentoLavado)}%)"></div>
                    `;
                }
                
                // Agregar segmentos por motivo
                MOTIVOS.forEach((motivo, index) => {
                    const cantidad = estadisticas.porMotivo[motivo];
                    if (cantidad > 0) {
                        const porcentajeSegmento = (cantidad / estadisticas.total) * 100;
                        contenidoHTML += `
                            <div class="segmento-motivo${index + 1}" style="width: ${porcentajeSegmento}%"
                                 title="${motivo}: ${cantidad} (${Math.round(porcentajeSegmento)}%)"></div>
                        `;
                    }
                });
                
                // Agregar segmento para "Otro" si existe
                if (estadisticas.porMotivo["Otro"] > 0) {
                    const porcentajeSegmentoOtro = (estadisticas.porMotivo["Otro"] / estadisticas.total) * 100;
                    contenidoHTML += `
                        <div class="segmento-motivo4" style="width: ${porcentajeSegmentoOtro}%"
                             title="Otro motivo: ${estadisticas.porMotivo["Otro"]} (${Math.round(porcentajeSegmentoOtro)}%)"></div>
                    `;
                }
                
                contenidoHTML += '</div>';
                semanaDiv.innerHTML = contenidoHTML;
                container.appendChild(semanaDiv);
            });
        }

function renderizarTablaSemanas(data) {
    const thead = document.querySelector('#tablaSemanas thead tr');
    const tbody = document.getElementById('tablaSemanasCuerpo');
    
    // Limpiar contenido previo
    thead.innerHTML = '<th style="width: 300px; min-width: 300px; text-align: left;">Ubicación / Sub-Ubicación</th>';
    tbody.innerHTML = '';
    
    // Crear encabezados de semanas
    Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
        const th = document.createElement('th');
        th.className = 'text-center';
        th.innerHTML = `Sem ${semana}`;
        thead.appendChild(th);
    });
    
    // Generar lista completa de ubicaciones (con formato "Ubicación - Sub-ubicación")
    const todasUbicaciones = generarListaUbicacionesCompleta();
    
    // Crear filas para cada ubicación/sub-ubicación
    todasUbicaciones.forEach(item => {
        const tr = document.createElement('tr');
        
        // Celda de ubicación/sub-ubicación con formato "Ubicación - Sub-ubicación"
        let ubicacionHTML = `<td class="fw-bold" style="text-align: left;">`;
        
        if (item.esSubUbicacion) {
            ubicacionHTML += `
                <div class="sububicacion-con-ubicacion">
                    <div class="texto-ubicacion-principal">${item.ubicacionPrincipal}</div>
                    <div class="texto-sububicacion">${item.nombre}</div>
                </div>
            `;
        } else {
            ubicacionHTML += item.nombre;
        }
        
        ubicacionHTML += `</td>`;
        
        // Celdas de semanas
        Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
            const ubicacionKey = item.esSubUbicacion ? item.ubicacionPrincipal : item.nombre;
            const nombreCompleto = item.esSubUbicacion ? `${item.ubicacionPrincipal} - ${item.nombre}` : item.nombre;
            const ubicacionEnSemana = data.resumenSemanas[semana].ubicaciones[ubicacionKey];
            
            let contenido = '';
            let clase = '';
            let motivo = '';
            let url = '';
            let rowNumber = null;
            let tieneMotivo = false;
            
            if (ubicacionEnSemana) {
                // Si es sub-ubicación, buscar específicamente en los datos del servidor
                if (item.esSubUbicacion) {
                    // Buscar en la lista de reportes si hay registro para esta sub-ubicación
                    const reporteEnSemana = data.listaReportes.find(reporte => 
                        reporte.semana === semana && 
                        reporte.ubicacion === item.ubicacionPrincipal &&
                        reporte.subUbicacion === item.nombre
                    );
                    
                    if (reporteEnSemana) {
                        if (reporteEnSemana.esLavado) {
                            contenido = '<i class="fas fa-check"></i>';
                            clase = 'estado-lavado';
                            url = reporteEnSemana.url;
                            rowNumber = reporteEnSemana.rowNumber;
                        } else {
                            contenido = '<i class="fas fa-times"></i>';
                            clase = getClasePorMotivo(reporteEnSemana.motivo);
                            motivo = reporteEnSemana.motivo;
                            tieneMotivo = true;
                            rowNumber = reporteEnSemana.rowNumber;
                        }
                    }
                } else {
                    // Es ubicación principal (sin sub-ubicaciones)
                    if (ubicacionEnSemana.lavado) {
                        contenido = '<i class="fas fa-check"></i>';
                        clase = 'estado-lavado';
                        // Buscar URL en lista de reportes
                        const reporteEnSemana = data.listaReportes.find(reporte => 
                            reporte.semana === semana && 
                            reporte.ubicacion === item.nombre &&
                            !reporte.subUbicacion
                        );
                        if (reporteEnSemana) {
                            url = reporteEnSemana.url;
                            rowNumber = reporteEnSemana.rowNumber;
                        }
                    } else {
                        contenido = '<i class="fas fa-times"></i>';
                        clase = getClasePorMotivo(ubicacionEnSemana.motivo);
                        motivo = ubicacionEnSemana.motivo;
                        tieneMotivo = true;
                        // Buscar rowNumber en lista de reportes para eliminación
                        const reporteEnSemana = data.listaReportes.find(reporte => 
                            reporte.semana === semana && 
                            reporte.ubicacion === item.nombre &&
                            !reporte.subUbicacion
                        );
                        if (reporteEnSemana) {
                            rowNumber = reporteEnSemana.rowNumber;
                        }
                    }
                }
            }
            
            // Construir celda
            if (contenido === '') {
                ubicacionHTML += `<td class="text-muted"><div class="icono-centrado">-</div></td>`;
            } else if (tieneMotivo) {
                // Celda con X, motivo y botón de eliminar
                ubicacionHTML += `
                    <td class="${clase}">
                        <div class="icono-centrado">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-1 motivo-tooltip">
                                    <i class="fas fa-times"></i>
                                    <span class="motivo-texto">${motivo}</span>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <button class="btn btn-action btn-delete" onclick="confirmarEliminar('${url || ''}', ${rowNumber}, '${nombreCompleto}', '${semana}', ${tieneMotivo})" title="Eliminar registro">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
            } else if (url) {
                // Celda con check y botones de acción
                ubicacionHTML += `
                    <td class="${clase}">
                        <div class="icono-centrado">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-1">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <button class="btn btn-action btn-pdf" onclick="verPDF('${url}')" title="Ver Reporte">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-action btn-share" onclick="compartirPDF('${url}', '${nombreCompleto}', '${semana}')" title="Compartir">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                    <button class="btn btn-action btn-download" onclick="descargarPDF('${url}')" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-action btn-delete" onclick="confirmarEliminar('${url}', ${rowNumber}, '${nombreCompleto}', '${semana}', ${tieneMotivo})" title="Eliminar">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
            } else {
                // Celda solo con check (sin URL)
                ubicacionHTML += `
                    <td class="${clase}">
                        <div class="icono-centrado">
                            ${contenido}
                        </div>
                    </td>
                `;
            }
        });
        
        tr.innerHTML = ubicacionHTML;
        tbody.appendChild(tr);
    });
}


        function generarListaUbicacionesCompleta() {
            const todasUbicaciones = [];
            
            // Recorrer ubicaciones del estado global
            Object.keys(datosGlobales.ubicacionesEstado).sort().forEach(ubicacion => {
                // Verificar si esta ubicación tiene sub-ubicaciones
                const tieneSubUbicaciones = SUB_UBICACIONES_POR_PROYECTO[proyectoActual] && 
                                           SUB_UBICACIONES_POR_PROYECTO[proyectoActual][ubicacion] &&
                                           SUB_UBICACIONES_POR_PROYECTO[proyectoActual][ubicacion].length > 0;
                
                if (tieneSubUbicaciones) {
                    // Agregar las sub-ubicaciones con formato "Ubicación - Sub-ubicación"
                    SUB_UBICACIONES_POR_PROYECTO[proyectoActual][ubicacion].sort().forEach(subUbicacion => {
                        todasUbicaciones.push({
                            nombre: subUbicacion,
                            esSubUbicacion: true,
                            ubicacionPrincipal: ubicacion
                        });
                    });
                } else {
                    // Agregar ubicación principal (no tiene sub-ubicaciones)
                    todasUbicaciones.push({
                        nombre: ubicacion,
                        esSubUbicacion: false,
                        ubicacionPrincipal: null
                    });
                }
            });
            
            return todasUbicaciones;
        }

function getClasePorMotivo(motivo) {
    if (!motivo) return 'estado-motivo4';
    
    const motivoLower = motivo.toLowerCase();
    
    // Mapear motivos específicos a clases de color
    if (motivoLower.includes('área no disponible') || motivoLower.includes('area no disponible')) {
        return 'estado-motivo1';
    } else if (motivoLower.includes('indisponibilidad de agua') || motivoLower.includes('agua')) {
        return 'estado-motivo2';
    } else if (motivoLower.includes('solicitud del cliente') || motivoLower.includes('cliente')) {
        return 'estado-motivo3';
    } else if (motivoLower.includes('no se hizo') || motivoLower.includes('no se realizó')) {
        return 'estado-motivo4';
    } else {
        return 'estado-motivo4'; // Gris por defecto
    }
}

        // FUNCIONES PARA MANEJO DE PDFs - IGUAL QUE LA PÁGINA DE REFERENCIA
        function verPDF(url) {
            if(!url) return;
            let previewUrl = url;
            if (url.includes('/view')) {
                previewUrl = url.replace(/\/view.*/, '/preview');
            }
            document.getElementById('iframePDF').src = previewUrl;
            modalPDF.show();
        }

        function getDriveId(url) {
            if (!url) return null;
            let match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) return match[1];
            match = url.match(/id=([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        function descargarPDF(url) {
            const id = getDriveId(url);
            if (id) {
                const downloadLink = `https://drive.google.com/uc?export=download&id=${id}`;
                window.open(downloadLink, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo obtener el ID del archivo', 'error');
            }
        }

        async function compartirPDF(url, ubicacion, semana) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Reporte Oasis ${ubicacion}`,
                        text: `Reporte de lavado de oasis en ${ubicacion} - Semana ${semana}`,
                        url: url
                    });
                } catch (err) {
                    console.log('Error compartiendo:', err);
                }
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Enlace copiado',
                        text: 'El enlace del reporte se ha copiado al portapapeles.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        }

function confirmarEliminar(url, rowNumber, ubicacion, semana, tieneMotivo) {
    const tipoRegistro = tieneMotivo ? "registro de motivo" : "reporte con archivo";
    
    Swal.fire({
        title: `Eliminar ${tieneMotivo ? 'Motivo' : 'Reporte'}`,
        text: `¿Estás seguro de eliminar este ${tipoRegistro}? Ingresa la contraseña para confirmar:`,
        input: 'password',
        inputAttributes: {
            autocapitalize: 'off',
            placeholder: 'Contraseña'
        },
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        confirmButtonColor: '#e74c3c',
        cancelButtonText: 'Cancelar',
        allowOutsideClick: false,
        backdrop: `rgba(43, 62, 80, 0.8)`,
        preConfirm: (password) => {
            if (password !== 'argos123') {
                Swal.showValidationMessage('Contraseña incorrecta');
                return false;
            }
            return password;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            ejecutarEliminacion(rowNumber, url);
        }
    });
}


        function ejecutarEliminacion(rowNumber, fileUrl) {
            const proyecto = document.getElementById('filtroProyecto').value;
            const mesVal = document.getElementById('filtroMes').value;
            const anio = document.getElementById('filtroAnio').value;

            showLoading("Por favor espera un momento...", "Esto puede tardar unos segundos");

            const xhr = new XMLHttpRequest();
            xhr.open('POST', URL_SCRIPT_GOOGLE_OASIS, true);
            xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
            
            xhr.onload = function() {
                hideLoading();
                try {
                    const responseText = xhr.responseText;
                    let cleanResponse = responseText;
                    if (cleanResponse.includes('//')) {
                        cleanResponse = cleanResponse.substring(cleanResponse.indexOf('{'));
                    }
                    
                    const data = JSON.parse(cleanResponse);
                    
                    if (data.status === "success") {
                        Swal.fire("Eliminado", "Reporte eliminado correctamente", "success")
                        .then(() => {
                            consultarDatosOasis(); // Recargar datos
                        });
                    } else {
                        Swal.fire("Error", data.message || "Error al eliminar", "error");
                    }
                } catch (error) {
                    hideLoading();
                    Swal.fire("Error", "Error procesando respuesta: " + error.message, "error");
                }
            };
            
            xhr.onerror = function() {
                hideLoading();
                Swal.fire("Error", "Error de conexión al eliminar", "error");
            };
            
            const requestData = {
                action: "eliminarReporte",
                proyecto: proyecto,
                mes: mesVal,
                anio: anio,
                rowNumber: rowNumber,
                fileUrl: fileUrl
            };
            
            xhr.send(JSON.stringify(requestData));
        }
    </script>
</body>
</html>
