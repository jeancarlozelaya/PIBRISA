<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reporte de Actividades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<style>
    /* --- INICIO: Estilos Base --- */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
        --success-color: #2ecc71;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --light-yellow: #fff9e6;
        /* Colores de Solicitud de Insumos */
        --insumos-primary: #3f7b57;
        --insumos-accent: #2196F3;
        --insumos-light-gray: #f0f2f5;
        --insumos-danger: #ef5350;
    }

    /* DESACTIVAR ZOOM EN TODA LA PÁGINA */
    html, body {
        touch-action: manipulation;
        overflow-x: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--insumos-light-gray);
        color: var(--dark-color);
        line-height: 1.6;
        zoom: 1;
        max-zoom: 1;
        min-zoom: 1;
        user-zoom: fixed;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        text-size-adjust: 100%;
        -webkit-user-scalable: no;
        -moz-user-scalable: no;
        -ms-user-scalable: no;
        user-scalable: no;
    }

    /* Prevenir zoom con doble toque en iOS */
    * {
        touch-action: pan-x pan-y;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
        z-index: 100;
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
        font-weight: bold;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
        position: relative;
        z-index: 1;
    }

    .card {
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: none;
        margin-bottom: 25px;
        border-top: 5px solid var(--insumos-primary);
    }
    
    .card-body {
        padding: 2.5rem;
    }
    
    .tab-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        padding: 20px 0;
        position: relative;
    }

    .tab-title h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        display: inline-block;
        padding: 0 25px;
        position: relative;
    }

    .tab-title h2:after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border-radius: 2px;
    }

    .tab-title h2:before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        right: 0;
        height: 1px;
        background-color: var(--border-color);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    /* Estilos de botones de formulario (Gestión) */
    .btn-primary, .btn-success, .btn-secondary, .btn-danger {
        border: none;
        font-weight: 600;
        padding: 10px 25px;
        font-size: 0.95rem;
        border-radius: 50px;
        min-width: 130px;
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-primary { background: linear-gradient(45deg, var(--secondary-color), #5dade2); }
    .btn-success { background: linear-gradient(45deg, #2ecc71, #58d68d); }
    
    .btn-secondary { 
        background: linear-gradient(45deg, var(--dark-color), var(--primary-color));
    }
    
    .btn-danger { background: linear-gradient(45deg, var(--accent-color), #e74c3c); }

    /* Botón para limpiar respuestas */
    .btn-warning {
        background: linear-gradient(45deg, #f39c12, #f1c40f);
        border: none;
        font-weight: 600;
        padding: 10px 25px;
        font-size: 0.95rem;
        border-radius: 50px;
        min-width: 130px;
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-primary:hover, .btn-success:hover, .btn-secondary:hover, .btn-danger:hover, .btn-warning:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .btn-primary:disabled {
        background: #ccc;
        box-shadow: none;
        transform: none;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
    }

    .area-supervision {
        background-color: #fdfdfd;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
    }
    
    .image-preview {
        width: 100%;
        min-height: 100px; /* Altura mínima para que se vea el dropzone */
        overflow-y: auto;
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
        background-color: var(--insumos-light-gray);
        margin-top: 10px;
    }

    .image-preview-item {
        position: relative;
        width: 90px;
        height: 90px;
        overflow: hidden;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, opacity 0.3s ease; /* Añadida opacidad */
    }

    .image-preview-item:hover {
        transform: translateY(-3px);
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: var(--insumos-danger);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .image-preview-item.deleting {
        transform: scale(0.8);
        opacity: 0;
    }

    /* Área de carga de archivos */
    .file-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 120px;
        background: var(--insumos-light-gray);
        border: 2px dashed var(--insumos-accent);
        border-radius: 10px;
        font-size: 1rem;
        color: var(--insumos-accent);
        cursor: pointer;
        margin-top: 15px;
        box-sizing: border-box;
        transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        text-align: center;
    }

    .file-upload:hover {
        border-color: var(--insumos-primary);
        background-color: rgba(33, 150, 243, 0.08);
        transform: translateY(-2px);
    }

    .file-upload input[type="file"] {
        display: none;
    }

    .file-upload-text {
        margin-top: 10px;
        font-weight: 500;
    }

    .file-upload i {
        font-size: 2.5em;
        color: var(--insumos-accent);
        margin-bottom: 5px;
    }

    /* --- Estilos Botón Flotante --- */
    .btn-flotante {
        position: fixed;
        bottom: 25px;
        left: 25px; /* Izquierda */
        width: 65px;
        height: 65px;
        background: linear-gradient(45deg, var(--secondary-color), #2980b9);
        color: white;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        z-index: 9999;
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-flotante:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    
    .btn-flotante:active {
        transform: scale(0.95);
    }

    /* --- Estilos Modal Cámara MEJORADO - PANTALLA COMPLETA --- */
    .camera-modal .modal-dialog {
        max-width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .camera-modal .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
        background-color: #000;
        border: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
    }
    
    .camera-modal .modal-header {
        border-bottom: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 10001;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 15px 20px;
        height: 60px;
        display: flex;
        align-items: center;
    }
    
    .camera-modal .modal-body {
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        touch-action: pinch-zoom pan-x pan-y; /* Permitir zoom táctil */
    }
    
    .camera-modal .modal-footer {
        border-top: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10001;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        height: 80px;
    }
    
    .camera-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .camera-view {
        width: 100vw;
        height: 100vh;
        background-color: #000;
        overflow: hidden;
        position: relative;
    }
    
    #camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* Eliminado transform: scaleX(-1) para móvil */
        transition: transform 0.3s ease;
    }
    
    .camera-controls {
        position: absolute;
        bottom: 100px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 30px;
        z-index: 10002;
    }
    
    .camera-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 3px solid white;
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .camera-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
    }
    
    .camera-btn:active {
        transform: scale(0.95);
    }
    
    .camera-btn.capture {
        width: 80px;
        height: 80px;
        background-color: white;
        color: #333;
        font-size: 30px;
    }
    
    .camera-btn.capture:hover {
        background-color: #f0f0f0;
    }
    
    .zoom-controls {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 10002;
    }
    
    .zoom-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
    }
    
    .zoom-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .flash-control {
        position: absolute;
        left: 20px;
        top: 80px;
        z-index: 10002;
    }
    
    .flash-btn {
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        border-radius: 25px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .flash-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .flash-btn.active {
        background-color: #f39c12;
        color: #000;
    }
    
    /* Eliminado el overlay del recuadro blanco */
    .camera-overlay {
        display: none;
    }
    
    .camera-message {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        font-size: 18px;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 10003;
    }
    
    /* Estado cuando no hay cámara */
    .no-camera .camera-view {
        background-color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        text-align: center;
        padding: 20px;
    }
    
    .no-camera .camera-controls {
        display: none;
    }
    
    .no-camera .zoom-controls {
        display: none;
    }
    
    .no-camera .flash-control {
        display: none;
    }

    /* Clase para esconder botón flotante cuando cámara está activa */
    .camera-active .btn-flotante {
        display: none !important;
    }

    /* --- Mensaje de foto tomada MEJORADO --- */
    .photo-capture-toast {
        position: absolute;
        bottom: 100px;
        right: 20px;
        background-color: rgba(46, 204, 113, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 16px;
        z-index: 10004;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s forwards;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .photo-capture-toast i {
        font-size: 20px;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            visibility: hidden;
        }
    }

    /* --- Modal de Vista Previa de Fotos - MEJORADO --- */
    .photo-preview-modal .modal-dialog {
        max-width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-preview-modal .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
        background-color: rgba(0, 0, 0, 0.95);
        border: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
    }

    .photo-preview-modal .modal-header {
        border-bottom: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 10001;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 15px 20px;
        height: 60px;
        display: flex;
        align-items: center;
    }

    .photo-preview-modal .modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.95);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        touch-action: pan-x pan-y;
    }

    .photo-preview-modal .modal-footer {
        border-top: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10001;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        height: 100px;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .photo-preview-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-bottom: 120px; /* Espacio para la fila de miniaturas */
    }

    .photo-view {
        width: 100vw;
        height: calc(100vh - 240px); /* Ajuste para header, footer y miniaturas */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }

    .photo-view img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .photo-info {
        position: absolute;
        top: 80px;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10002;
    }

    .photo-navigation {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 10002;
    }

    .nav-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.7;
    }

    .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        opacity: 1;
        transform: scale(1.1);
    }

    .nav-btn:active {
        transform: scale(0.95);
    }

    .nav-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .nav-btn.disabled:hover {
        background-color: rgba(0, 0, 0, 0.5);
        transform: none;
    }

    .photo-counter {
        position: absolute;
        top: 80px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10002;
    }

    .photo-actions {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .photo-action-btn {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white;
        border-radius: 25px;
        padding: 8px 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .photo-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .photo-action-btn.delete {
        background-color: rgba(239, 83, 80, 0.2);
        border-color: #ef5350;
    }

    .photo-action-btn.delete:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }

    .photo-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .photo-loading .spinner-border {
        width: 50px;
        height: 50px;
    }

    /* Fila de miniaturas en la parte inferior */
    .photo-thumbnails-container {
        position: absolute;
        bottom: 100px;
        left: 0;
        right: 0;
        height: 100px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px 0;
        z-index: 10002;
        overflow-x: auto;
        display: flex;
        justify-content: center;
    }

    .photo-thumbnails {
        display: flex;
        gap: 10px;
        padding: 0 10px;
        height: 100%;
    }

    .photo-thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 6px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        position: relative;
    }

    .photo-thumbnail:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .photo-thumbnail.active {
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }

    .photo-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-thumbnail-index {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 10px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .photo-exit-animation {
        animation: slideOut 0.3s ease-out;
    }

    @keyframes slideOut {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(0.8);
        }
    }

    .photo-enter-animation {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Eliminar la X de las miniaturas */
    .image-preview-item .delete-icon {
        display: none !important;
    }


/* Overlay de carga */
#overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(255, 255, 255, 0.95); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 9999; 
    flex-direction: column; 
}
.spinner { 
    width: 60px; 
    height: 60px; 
    border: 5px solid rgba(52, 152, 219, 0.2); 
    border-radius: 50%; 
    border-top-color: var(--secondary-color); 
    animation: spin 1s ease-in-out infinite; 
    margin-bottom: 20px; 
}
@keyframes spin { 
    to { transform: rotate(360deg); } 
}
#loadingMessage { 
    text-align: center; 
    color: var(--dark-color); 
}
#loadingMessage h4 { 
    margin: 0 0 10px; 
    font-size: 1.3rem; 
    font-weight: bold; 
}
#loadingMessage p { 
    margin: 0; 
    color: #7f8c8d; 
    font-weight: normal; 
}


/* NUEVO: Estilos para listas con scroll */
    .lista-scrollable {
        max-height: 350px; /* Altura máxima fija */
        overflow-y: auto;  /* Scroll vertical automático */
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #fff;
    }

    /* Estilo para la barra de herramientas (Seleccionar todos, eliminar) */
    .toolbar-lista {
        background-color: #f8f9fa;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-bottom: none; /* Se une con la lista */
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .cursor-pointer { cursor: pointer; }

/* ESTILOS PARA LAS PESTAÑAS DEL MODAL */

/* 1. Estilo base (Pestaña INACTIVA) */
#syncTabs .nav-link {
    background-color: #e9ecef; /* Fondo gris para las no seleccionadas */
    color: #7f8c8d;            /* Texto gris opaco */
    border: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6; /* Borde completo */
    margin-right: 4px;         /* Pequeña separación entre pestañas */
    border-radius: 8px 8px 0 0; /* Bordes redondeados solo arriba */
    transition: all 0.2s ease;
}

/* 2. Efecto Hover (Al pasar el mouse) */
#syncTabs .nav-link:hover {
    background-color: #dde1e3;
    color: #2c3e50;
}

/* 3. Estilo Pestaña ACTIVA (La que se está viendo) */
#syncTabs .nav-link.active {
    background-color: #ffffff !important; /* Blanco puro */
    color: #2c3e50 !important;            /* Texto oscuro y fuerte */
    font-weight: bold;
    border-color: #dee2e6 #dee2e6 #fff;   /* Borde inferior blanco para unirse al contenido */
    border-top: 4px solid #3498db;        /* Línea azul gruesa arriba para resaltar */
    transform: translateY(1px);           /* Pequeño ajuste visual */
}

/* 4. Ajuste del contenedor de las pestañas */
#syncTabs {
    border-bottom: 1px solid #dee2e6;
    background-color: #f8f9fa; /* Fondo general de la barra */
    padding-top: 10px;
    padding-left: 10px;
    padding-right: 10px;
}

</style>

</head>
<body>
    
    <div class="header">Pisos Brillantes</div>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050; margin-top: 5px;">
    <button id="btn-sync-manager" class="btn btn-light position-relative shadow-sm" style="border-radius: 50px; border: 1px solid var(--primary-color); display: none;">
        <i class="fas fa-cloud-upload-alt text-primary"></i>
        <span class="d-none d-md-inline ms-2 fw-bold text-dark">Sincronizar</span>
        <span id="badge-pendientes" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            0
            <span class="visually-hidden">reportes pendientes</span>
        </span>
    </button>
</div>

<div class="modal fade" id="modalSync" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="fas fa-sync me-2"></i>Gestor de Envíos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body bg-light p-0">
                <ul class="nav nav-tabs nav-justified" id="syncTabs" role="tablist" style="background: #fff; border-bottom: 1px solid #dee2e6;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold py-3" id="tab-pendientes" data-bs-toggle="tab" data-bs-target="#content-pendientes" type="button" role="tab">
                            <i class="fas fa-hourglass-half me-2 text-warning"></i>Pendientes
                            <span class="badge bg-danger ms-1" id="badge-tab-pendientes" style="display:none">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold py-3 text-secondary" id="tab-sincronizados" data-bs-toggle="tab" data-bs-target="#content-sincronizados" type="button" role="tab">
                            <i class="fas fa-check-circle me-2 text-success"></i>Sincronizados
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-3" id="syncTabsContent">
                    
                    <div class="tab-pane fade show active" id="content-pendientes" role="tabpanel">
                        <div class="alert alert-info border-0 shadow-sm py-2 mb-2">
                            <small><i class="fas fa-info-circle me-1"></i> Selecciona los registros para subir o eliminar.</small>
                        </div>

                        <div class="toolbar-lista">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="check-all-pendientes">
                                <label class="form-check-label small fw-bold" for="check-all-pendientes">Seleccionar Todos</label>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" id="btn-delete-pendientes-sel" disabled>
                                <i class="fas fa-trash-alt me-1"></i> Eliminar Selección
                            </button>
                        </div>

                        <div class="list-group list-group-flush lista-scrollable mb-2" id="lista-pendientes">
                            </div>

                        <div class="d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-primary rounded-pill" id="btn-sincronizar-seleccionados" disabled>
                                <i class="fas fa-cloud-upload-alt me-2"></i>Sincronizar Seleccionados
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-sincronizados" role="tabpanel">
                        <div class="alert alert-light border shadow-sm text-muted py-2 mb-2">
                            <small><i class="fas fa-check-double me-1"></i> Historial de envíos exitosos.</small>
                        </div>

                        <div class="toolbar-lista">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="check-all-sincronizados">
                                <label class="form-check-label small fw-bold" for="check-all-sincronizados">Seleccionar Todos</label>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" id="btn-delete-sincronizados-sel" disabled>
                                <i class="fas fa-trash-alt me-1"></i> Eliminar Selección
                            </button>
                        </div>

                        <div class="list-group list-group-flush lista-scrollable mb-2" id="lista-sincronizados">
                            </div>

                        <div class="d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-outline-primary rounded-pill" id="btn-resync-seleccion" disabled>
                                <i class="fas fa-redo me-2"></i> Volver a Sincronizar Seleccionados
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



<img id="logo-loader" src="" style="display: none;" alt="Logo">

    <div class="container">
        <h1>Reporte de Limpiezas Profundas</h1>

        <div class="card">
            <div class="card-body p-4 p-md-5">

                <form id="form-actividades">
                    
                    <!-- PÁGINA ÚNICA: ACTIVIDAD -->
                    <div id="pagina-1" class="pagina active">
                        <div class="tab-title">
                            <h2>Datos de la Actividad</h2>
                        </div>
                        
<div class="row">
    <div class="col-md-4 mb-3">
        <label for="fecha-actividad" class="form-label">Fecha</label>
        <input type="date" class="form-control auto-save" id="fecha-actividad" required>
    </div>
    <div class="col-md-4 mb-3">
        <label for="select-proyecto" class="form-label">Proyecto</label>
        <select class="form-select auto-save" id="select-proyecto" required>
            <option value="">Seleccionar...</option>
            <option value="ARPIA">ARPIA</option>
            <option value="ARRIO">ARRIO</option>
        </select>
    </div>
    <div class="col-md-4 mb-3">
        <label for="select-ubicacion" class="form-label">Ubicación</label>
        <select class="form-select auto-save" id="select-ubicacion" required disabled>
            <option value="">Seleccione un proyecto primero...</option>
        </select>
    </div>
</div>                        
                        <div class="mb-3">
                            <label for="descripcion-actividad" class="form-label">Descripción de la Actividad</label>
                            <textarea class="form-control auto-save" id="descripcion-actividad" rows="6" placeholder="Describa la actividad realizada..." required></textarea>
                        </div>
                        
                        <div class="seccion-fotos mb-4">
                            <label class="form-label">Evidencia</label>
                            
                            <div class="d-flex gap-3 mb-3">
                                <div class="file-upload flex-grow-1" onclick="openCamera('preview-actividad')">
                                    <i class="fas fa-camera"></i>
                                    <span class="file-upload-text">Haz clic para tomar una fotografía</span>
                                </div>
                                
                                <div class="file-upload flex-grow-1" onclick="openGallery('preview-actividad')">
                                    <i class="fas fa-images"></i>
                                    <span class="file-upload-text">Seleccionar de la galería</span>
                                </div>
                            </div>
                            
                            <div id="preview-actividad" class="image-preview"></div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary" id="btn-enviar-actividad">
                                <i class="fas fa-paper-plane me-2"></i> Enviar Reporte
                            </button>
                        </div>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <!-- Modal de Cámara (solo para desktop) - MEJORADO -->
    <div class="modal fade camera-modal" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-camera me-2"></i>Cámara
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <div class="camera-view">
                            <video id="camera-video" autoplay playsinline></video>
                            <canvas id="camera-canvas" style="display:none;"></canvas>
                            <div id="camera-message" class="camera-message" style="display:none;">
                                No se pudo acceder a la cámara
                            </div>
                        </div>
                        <div class="flash-control">
                            <button class="flash-btn" id="flash-toggle">
                                <i class="fas fa-bolt"></i>
                                <span>Flash</span>
                            </button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoom-in">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="zoom-btn" id="zoom-out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                        </div>
                        <div class="camera-controls">
                            <!-- Botón de captura únicamente -->
                            <button class="camera-btn capture" id="capture-btn" title="Tomar foto">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Vista Previa de Fotos -->
    <div class="modal fade photo-preview-modal" id="photoPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-images me-2"></i>Vista Previa de Fotos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="photo-preview-container">
                        <div class="photo-counter" id="photo-counter">
                            1 de 1
                        </div>
                        
                        <div class="photo-view">
                            <div class="photo-loading" id="photo-loading">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <span>Cargando foto...</span>
                            </div>
                            <img id="preview-photo" src="" alt="Vista previa" style="display: none;">
                        </div>
                        
                        <div class="photo-navigation">
                            <button class="nav-btn" id="prev-photo">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="nav-btn" id="next-photo">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Fila de miniaturas -->
                        <div class="photo-thumbnails-container">
                            <div class="photo-thumbnails" id="photo-thumbnails">
                                <!-- Las miniaturas se generarán dinámicamente aquí -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="photo-actions">
                        <button class="photo-action-btn" id="download-photo">
                            <i class="fas fa-download me-2"></i>Descargar
                        </button>
                        <button class="photo-action-btn delete" id="delete-photo">
                            <i class="fas fa-trash me-2"></i>Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="btn-camara-flotante" type="button" class="btn-flotante" style="display: none;">
        <i class="fas fa-camera"></i>
    </button>

<!-- Overlay de carga -->
<div id="overlay">
    <div class="spinner"></div>
    <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
    </div>
</div>


<div class="modal fade" id="modalPdfPreview" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-file-pdf me-2"></i>Vista Previa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body bg-secondary d-flex justify-content-center" style="overflow-y: auto;">
                <div id="pdf-render-container" class="d-flex flex-column align-items-center w-100 p-2">
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
        
// =========================================================================
// CONFIGURACIÓN CENTRALIZADA
// =========================================================================

const SESSION_KEY = 'actividadesSessionData';
const DB_NAME = 'ActividadesImageDB';
const STORE_NAME = 'images';                 
const STORE_PENDING = 'pending_reports';
let db; // Variable global para la base de datos

// =========================================================================
// CONFIGURACIÓN DE UBICACIONES POR PROYECTO
// =========================================================================

const CONFIG_UBICACIONES = {
    "ARPIA": [
        "Administración",
        "Almacén General",
        "Baños de Transportistas",
        "Bodega de Limpieza",
        "Camerinos",
        "Club de Argos",
        "Despacho",
        "Enfermería",
        "Equipo Móvil",
        "Expedición",
        "Laboratorio de Calidad",
        "Laboratorio de Concreto",
        "Machaqueo A",
        "Posta Principal",
        "Sala de Control",
        "Sala de Maternidad",
        "Sala de Reuniones Chiminique",
        "Salón Vial",
        "Taller Eléctrico"
    ],
    "ARRIO": [
        "Administración",
        "Baños de Transportistas",
        "Baños Principales",
        "Báscula",
        "Bodega de Limpieza",
        "Cafetería",
        "Camerinos",
        "Clínica",
        "Laboratorio de Calidad",
        "Posta Principal",
        "Sala de Control"
    ]
};

// =========================================================================
// VARIABLES GLOBALES Y ESTADO
// =========================================================================

// Almacén para IDs de fotos
let selectedFiles = {};

// Variables globales
let $form, logoBase64_Cache = null;

// Variables para página
let $selectProyecto, $fechaInput, $descripcionInput, $selectUbicacion;

// Variables para cámara
let currentPreviewId = null;
let cameraStream = null;
let currentFacingMode = 'environment';
let zoomLevel = 1;
let flashOn = false;
let isMobileDevice = false;

// Variables para zoom táctil
let initialPinchDistance = 0;
let lastZoomLevel = 1;

// Variables para vista previa de fotos
let currentPhotoPreview = null;

// Variable global para seguimiento
window.isSyncing = false;

// =========================================================================
// FUNCIONES DE DETECCIÓN DE DISPOSITIVO
// =========================================================================

function esDispositivoMovil() {
    const userAgent = navigator.userAgent.toLowerCase();
    const esMovil = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/i.test(userAgent);
    const plataforma = navigator.platform.toLowerCase();
    const esPlataformaMovil = /android|iphone|ipad|ipod/i.test(plataforma);
    return esMovil || esPlataformaMovil;
}

// =========================================================================
// FUNCIONES DE INICIALIZACIÓN
// =========================================================================

async function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 2);

        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            // Almacén de imágenes
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
            // Almacén de reportes pendientes
            if (!db.objectStoreNames.contains(STORE_PENDING)) {
                db.createObjectStore(STORE_PENDING, { keyPath: 'id', autoIncrement: true });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log('IndexedDB de Actividades abierta correctamente');
            actualizarContadorPendientes();
            resolve(db);
        };

        request.onerror = function(event) {
            console.error('Error DB:', event.target.error);
            reject(event.target.error);
        };
    });
}

function loadLogoCache() {
    const img = document.getElementById('logo-loader');
    if (!img) {
        logoBase64_Cache = null;
        return;
    }
    const convertLogo = () => {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            logoBase64_Cache = canvas.toDataURL('image/png');
            console.log('Logo local cargado y cacheado.');
        } catch (e) {
            console.error('Error al convertir el logo local (CORS?):', e);
            logoBase64_Cache = null;
        }
    };
    if (img.complete && img.naturalHeight !== 0) {
        convertLogo();
    } else {
        img.onload = convertLogo;
        img.onerror = () => {
            logoBase64_Cache = null;
        };
    }
}

// =========================================================================
// FUNCIONES PARA UBICACIONES
// =========================================================================

function actualizarUbicaciones() {
    const proyectoVal = $selectProyecto.val();
    
    $selectUbicacion.empty();
    
    if (!proyectoVal) {
        $selectUbicacion.append('<option value="">Seleccione un proyecto primero...</option>');
        $selectUbicacion.prop('disabled', true);
    } else if (CONFIG_UBICACIONES[proyectoVal] !== undefined) {
        const ubicaciones = CONFIG_UBICACIONES[proyectoVal];
        $selectUbicacion.append('<option value="">Seleccionar Ubicación...</option>');
        ubicaciones.forEach((ubicacion) => {
            $selectUbicacion.append(`<option value="${ubicacion}">${ubicacion}</option>`);
        });
        $selectUbicacion.prop('disabled', false);
    } else {
        $selectUbicacion.append('<option value="">Seleccione un proyecto primero...</option>');
        $selectUbicacion.prop('disabled', true);
    }
}

// =========================================================================
// FUNCIONES DE SESIÓN
// =========================================================================

function saveSession() {
    if (!db) return;
    
    const sessionData = {
        fecha: $('#fecha-actividad').val(),
        proyecto: $('#select-proyecto').val(),
        ubicacion: $('#select-ubicacion').val(),
        descripcion: $('#descripcion-actividad').val(),
        fotos: selectedFiles
    };
    
    localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
}

async function loadSession() {
    const dataString = localStorage.getItem(SESSION_KEY);
    if (!dataString) return;
    
    try {
        const data = JSON.parse(dataString);
        
        $('#fecha-actividad').val(data.fecha);
        $('#select-proyecto').val(data.proyecto);
        
        // Actualizar ubicaciones y seleccionar la guardada
        actualizarUbicaciones();
        $('#select-ubicacion').val(data.ubicacion);
        
        $('#descripcion-actividad').val(data.descripcion);
        
        if (data.fotos) {
            selectedFiles = data.fotos;
            for (const previewId in selectedFiles) {
                await renderFotosPreview(previewId);
            }
        }
        
        saveSession();

    } catch (e) {
        console.error("Error al cargar sesión:", e);
        await clearSession();
    }
}

async function clearSession() {
    localStorage.removeItem(SESSION_KEY);
    selectedFiles = {};
    
    // Limpiar campos
    $('#fecha-actividad').val('');
    $('#select-proyecto').val('');
    $('#select-ubicacion').val('');
    $('#select-ubicacion').prop('disabled', true);
    $('#descripcion-actividad').val('');
    $('#preview-actividad').empty();
    
    if (db) {
        try {
            await clearImageDB();
            console.log("IndexedDB de imágenes limpiada.");
        } catch (error) {
            console.error("No se pudo limpiar la IndexedDB:", error);
        }
    }
}

async function checkForSavedSession() {
    return new Promise((resolve) => {
        if (localStorage.getItem(SESSION_KEY)) {
            Swal.fire({
                title: 'Trabajo Pendiente',
                text: 'Detectamos un reporte de actividad que no fue enviado. ¿Deseas recuperarlo?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, recuperarlo',
                cancelButtonText: 'No, empezar de cero',
                allowOutsideClick: false
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await loadSession();
                    Swal.fire('¡Listo!', 'Tu sesión ha sido restaurada.', 'success');
                } else if (result.isDismissed) { 
                    Swal.fire({
                        title: '¿Estás 100% seguro?',
                        html: "Esta acción es irreversible y todo su progreso se perderá.",
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, borrar todo',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#e74c3c'
                    }).then(async (deleteResult) => {
                        if (deleteResult.isConfirmed) {
                            await clearSession();
                            Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                        } else {
                            await loadSession();
                            Swal.fire('¡Restaurado!', 'Tu sesión ha sido restaurada.', 'success');
                        }
                        resolve();
                    });
                    return;
                }
                resolve();
            });
        } else {
            resolve();
        }
    });
}

// =========================================================================
// FUNCIONES DE FOTOS (INDEXEDDB)
// =========================================================================

function saveImageToDB(base64Data) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add({ image: base64Data });
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

function getImageFromDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = (event) => resolve(event.target.result ? event.target.result.image : null);
        request.onerror = (event) => reject(event.target.error);
    });
}

function deleteImageFromDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function clearImageDB() {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
}

async function renderFotosPreview(previewId) {
    const previewContainer = document.getElementById(previewId);
    if (!previewContainer) return; 
    
    previewContainer.innerHTML = '';
    const idArray = selectedFiles[previewId] || [];
    if (!db && idArray.length > 0) {
        previewContainer.innerHTML = '<p class="text-danger">Error: DB de fotos no lista.</p>';
        return;
    }
    
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < idArray.length; i++) {
        const id = idArray[i];
        try {
            const base64String = await getImageFromDB(id);
            if (base64String) {
                const div = document.createElement("div");
                div.classList.add("image-preview-item");
                div.setAttribute('data-id', id);
                div.setAttribute('data-index', i);
                div.setAttribute('data-preview-id', previewId);
                div.style.cursor = 'pointer';
                div.onclick = function() {
                    openPhotoPreview(previewId, i); 
                };
                
                div.innerHTML = `
                    <img src="${base64String}" alt="Vista previa ${id}">
                `;
                fragment.appendChild(div);
            } else {
                console.warn(`Image ID ${id} no encontrado en DB.`);
                selectedFiles[previewId] = selectedFiles[previewId].filter(dbId => dbId !== id);
                saveSession();
            }
        } catch (error) {
            console.error(`Error al cargar imagen ID ${id}:`, error);
        }
    }
    
    previewContainer.appendChild(fragment);
    updateFloatingButtonVisibility();
}

// =========================================================================
// FUNCIONES PARA CÁMARA
// =========================================================================

function openCamera(previewId) {
    currentPreviewId = previewId;
    isMobileDevice = esDispositivoMovil();
    
    const userAgent = navigator.userAgent.toLowerCase();
    const esWindows = userAgent.includes('windows') || userAgent.includes('win32');
    const esMac = userAgent.includes('macintosh') || userAgent.includes('mac os');
    const esLinux = userAgent.includes('linux') && !userAgent.includes('android');
    
    if (esWindows || esMac || esLinux) {
        openCameraModal();
        return;
    }
    
    if (isMobileDevice) {
        openNativeCamera();
    } else {
        openCameraModal();
    }
}

function openGallery(previewId) {
    currentPreviewId = previewId;
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true;
    
    input.onchange = async function(e) {
        if (e.target.files && e.target.files.length > 0) {
            for (let i = 0; i < e.target.files.length; i++) {
                const file = e.target.files[i];
                await handleCameraPhoto(file, true); // true = SÍ es de galería
            }
        }
    };
    
    input.click();
}

function openNativeCamera() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    
    input.onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            await handleCameraPhoto(file, false); // false = NO es de galería
        }
    };
    
    input.click();
}

function openCameraModal() {
    $('body').addClass('camera-active');
    
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'), {
        backdrop: 'static',
        keyboard: false
    });
    cameraModal.show();
    
    $('#cameraModal').on('shown.bs.modal', async function() {
        await initializeCamera();
        addTouchZoomEvents();
    });
    
    $('#cameraModal').on('hidden.bs.modal', function() {
        stopCamera();
        resetCameraControls();
        $('body').removeClass('camera-active');
        updateFloatingButtonVisibility();
        removeTouchZoomEvents();
    });
}

async function initializeCamera() {
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showCameraError('Tu navegador no soporta el acceso a la cámara.');
            return;
        }
        
        const constraints = {
            video: {
                facingMode: currentFacingMode,
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('camera-video');
        videoElement.srcObject = cameraStream;
        
        if (isMobileDevice) {
            videoElement.style.transform = 'none';
        } else {
            videoElement.style.transform = 'scaleX(-1)';
        }
        
        applyZoom();
        $('#camera-message').hide();
        
    } catch (error) {
        console.error('Error al acceder a la cámara:', error);
        showCameraError('No se pudo acceder a la cámara. Verifica los permisos.');
    }
}

function showCameraError(message) {
    $('#camera-message').text(message).show();
    $('.camera-container').addClass('no-camera');
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    const videoElement = document.getElementById('camera-video');
    if (videoElement) {
        videoElement.srcObject = null;
    }
}

function resetCameraControls() {
    zoomLevel = 1;
    flashOn = false;
    currentFacingMode = 'environment';
    $('#flash-toggle').removeClass('active');
    applyZoom();
}

function applyZoom() {
    const videoElement = document.getElementById('camera-video');
    if (videoElement) {
        if (isMobileDevice) {
            videoElement.style.transform = `scale(${zoomLevel})`;
        } else {
            videoElement.style.transform = `scaleX(-1) scale(${zoomLevel})`;
        }
    }
}

async function addDateTimeToImage(base64Data) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(img, 0, 0);
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateTimeStr = `${dateStr} ${timeStr}`;
            
            const baseFontSize = Math.max(img.width * 0.05, 40);
            const fontSize = Math.min(baseFontSize, 80);
            
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = fontSize * 0.1;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'bottom';
            
            const padding = fontSize * 0.8;
            const textX = padding;
            const textY = canvas.height - padding;
            
            ctx.strokeText(dateTimeStr, textX, textY);
            ctx.fillText(dateTimeStr, textX, textY);
            
            const newBase64 = canvas.toDataURL('image/jpeg', 0.9);
            resolve(newBase64);
        };
        img.onerror = () => resolve(base64Data);
        img.src = base64Data;
    });
}

function showPhotoCaptureToast() {
    $('.photo-capture-toast').remove();
    
    const toast = document.createElement('div');
    toast.className = 'photo-capture-toast';
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>Foto tomada</span>
    `;
    
    const cameraContainer = document.querySelector('.camera-container');
    if (cameraContainer) {
        cameraContainer.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 2000);
    }
}

async function handleCameraPhoto(file, fromGallery = false) {
    if (!currentPreviewId || !db) return;
    
    if (!selectedFiles[currentPreviewId]) {
        selectedFiles[currentPreviewId] = [];
    }
    
    const previewContainer = document.getElementById(currentPreviewId);
    const loadingHtml = `<div class="image-preview-item text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div></div>`;
    
    const tempSpinner = $(loadingHtml);
    previewContainer.appendChild(tempSpinner[0]);
    
    try {
        let base64Data = await fileToBase64(file);
        
        // SOLO agregar fecha/hora si NO es de la galería
        if (!fromGallery) {
            base64Data = await addDateTimeToImage(base64Data);
        }
        
        const newId = await saveImageToDB(base64Data);
        selectedFiles[currentPreviewId].push(newId);
        tempSpinner.remove();
        
        const div = document.createElement("div");
        div.classList.add("image-preview-item");
        div.innerHTML = `
            <img src="${base64Data}" alt="Vista previa ${newId}">
        `;
        div.onclick = function() {
            openPhotoPreview(currentPreviewId, selectedFiles[currentPreviewId].length - 1);
        };
        previewContainer.appendChild(div);
        
        // Solo mostrar toast para fotos tomadas (no de galería)
        if (!fromGallery) {
            showPhotoCaptureToast();
        }
        
        saveSession();
    } catch (error) {
        console.error("Error guardando foto en DB:", error);
        tempSpinner.remove();
        Swal.fire('Error de Foto', 'No se pudo guardar la imagen.', 'error');
    }
}


function capturePhoto() {
    if (!cameraStream) return;
    
    const videoElement = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    
    if (isMobileDevice) {
        context.setTransform(1, 0, 0, 1, 0, 0);
    } else {
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
    }
    
    if (zoomLevel !== 1) {
        const zoomedWidth = canvas.width * zoomLevel;
        const zoomedHeight = canvas.height * zoomLevel;
        const offsetX = (canvas.width - zoomedWidth) / 2;
        const offsetY = (canvas.height - zoomedHeight) / 2;
        
        context.setTransform(1, 0, 0, 1, 0, 0);
        if (isMobileDevice) {
            context.drawImage(videoElement, offsetX, offsetY, zoomedWidth, zoomedHeight, 0, 0, canvas.width, canvas.height);
        } else {
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(videoElement, offsetX, offsetY, zoomedWidth, zoomedHeight, 0, 0, canvas.width, canvas.height);
        }
    } else {
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    }
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    processCapturedPhoto(imageData);
    visualCaptureEffect();
}

async function processCapturedPhoto(imageData) {
    if (!currentPreviewId || !db) return;
    
    if (!selectedFiles[currentPreviewId]) {
        selectedFiles[currentPreviewId] = [];
    }
    
    try {
        // Para fotos tomadas con la cámara modal, SÍ agregamos fecha/hora
        const imageWithDateTime = await addDateTimeToImage(imageData);
        const newId = await saveImageToDB(imageWithDateTime);
        selectedFiles[currentPreviewId].push(newId);
        
        await renderFotosPreview(currentPreviewId);
        showPhotoCaptureToast();
        saveSession();
        
    } catch (error) {
        console.error("Error guardando foto en DB:", error);
        Swal.fire('Error de Foto', 'No se pudo guardar la imagen.', 'error');
    }
}

function visualCaptureEffect() {
    const cameraView = document.querySelector('.camera-view');
    if (cameraView) {
        cameraView.style.backgroundColor = 'white';
        
        setTimeout(() => {
            cameraView.style.backgroundColor = 'transparent';
        }, 100);
        
        if (flashOn) {
            setTimeout(() => {
                cameraView.style.backgroundColor = 'white';
            }, 50);
            
            setTimeout(() => {
                cameraView.style.backgroundColor = 'transparent';
            }, 150);
        }
    }
}

function toggleFlash() {
    flashOn = !flashOn;
    const flashBtn = $('#flash-toggle');
    
    if (flashOn) {
        flashBtn.addClass('active');
        $('.camera-view').css('filter', 'brightness(1.5)');
    } else {
        flashBtn.removeClass('active');
        $('.camera-view').css('filter', 'brightness(1)');
    }
}

function zoomIn() {
    if (zoomLevel < 3) {
        zoomLevel += 0.5;
        applyZoom();
    }
}

function zoomOut() {
    if (zoomLevel > 0.5) {
        zoomLevel -= 0.5;
        applyZoom();
    }
}

function addTouchZoomEvents() {
    const cameraView = document.querySelector('.camera-view');
    if (!cameraView) return;
    
    cameraView.addEventListener('touchstart', handleTouchStart, { passive: false });
    cameraView.addEventListener('touchmove', handleTouchMove, { passive: false });
    cameraView.addEventListener('touchend', handleTouchEnd, { passive: false });
}

function removeTouchZoomEvents() {
    const cameraView = document.querySelector('.camera-view');
    if (!cameraView) return;
    
    cameraView.removeEventListener('touchstart', handleTouchStart);
    cameraView.removeEventListener('touchmove', handleTouchMove);
    cameraView.removeEventListener('touchend', handleTouchEnd);
}

function handleTouchStart(e) {
    if (e.touches.length === 2) {
        e.preventDefault();
        initialPinchDistance = getPinchDistance(e.touches[0], e.touches[1]);
        lastZoomLevel = zoomLevel;
    }
}

function handleTouchMove(e) {
    if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getPinchDistance(e.touches[0], e.touches[1]);
        const pinchRatio = currentDistance / initialPinchDistance;
        
        let newZoomLevel = lastZoomLevel * pinchRatio;
        newZoomLevel = Math.max(0.5, Math.min(3, newZoomLevel));
        
        zoomLevel = newZoomLevel;
        applyZoom();
    }
}

function handleTouchEnd(e) {
    if (e.touches.length < 2) {
        initialPinchDistance = 0;
    }
}

function getPinchDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

// =========================================================================
// FUNCIONES PARA VISTA PREVIA DE FOTOS
// =========================================================================

function openPhotoPreview(previewId, startIndex = 0) {
    const idArray = selectedFiles[previewId] || [];
    if (idArray.length === 0) return;
    
    currentPhotoPreview = {
        previewId: previewId,
        photoIds: [...idArray],
        currentIndex: startIndex,
        totalPhotos: idArray.length
    };
    
    const photoPreviewModal = new bootstrap.Modal(document.getElementById('photoPreviewModal'), {
        backdrop: 'static',
        keyboard: false
    });
    photoPreviewModal.show();
    
    loadPhotoForPreview();
    updatePhotoCounter();
    generatePhotoThumbnails();
    setupPhotoPreviewEvents();
    
    $('body').addClass('camera-active');
}

async function loadPhotoForPreview() {
    if (!currentPhotoPreview) return;
    
    const { photoIds, currentIndex } = currentPhotoPreview;
    const currentId = photoIds[currentIndex];
    
    if (!currentId) return;
    
    $('#photo-loading').show();
    $('#preview-photo').hide();
    
    try {
        const base64String = await getImageFromDB(currentId);
        if (base64String) {
            const img = document.getElementById('preview-photo');
            img.src = base64String;
            
            setTimeout(() => {
                $('#photo-loading').hide();
                $('#preview-photo').show().addClass('photo-enter-animation');
                
                setTimeout(() => {
                    $('#preview-photo').removeClass('photo-enter-animation');
                }, 300);
            }, 300);
            
            updateNavigationButtons();
            updateActiveThumbnail();
        }
    } catch (error) {
        console.error("Error cargando foto para vista previa:", error);
        $('#photo-loading').html('<span>Error cargando la foto</span>');
    }
}

async function generatePhotoThumbnails() {
    if (!currentPhotoPreview) return;
    
    const { photoIds } = currentPhotoPreview;
    const $thumbnailsContainer = $('#photo-thumbnails');
    $thumbnailsContainer.empty();
    
    for (let i = 0; i < photoIds.length; i++) {
        try {
            const base64String = await getImageFromDB(photoIds[i]);
            if (base64String) {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'photo-thumbnail';
                if (i === currentPhotoPreview.currentIndex) {
                    thumbnail.classList.add('active');
                }
                thumbnail.setAttribute('data-index', i);
                thumbnail.onclick = function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (index !== currentPhotoPreview.currentIndex) {
                        currentPhotoPreview.currentIndex = index;
                        updatePhotoCounter();
                        loadPhotoForPreview();
                    }
                };
                
                thumbnail.innerHTML = `
                    <img src="${base64String}" alt="Miniatura ${i + 1}">
                    <div class="photo-thumbnail-index">${i + 1}</div>
                `;
                
                $thumbnailsContainer.append(thumbnail);
            }
        } catch (error) {
            console.error(`Error cargando miniatura ${i}:`, error);
        }
    }
}

function updateActiveThumbnail() {
    if (!currentPhotoPreview) return;
    
    const { currentIndex } = currentPhotoPreview;
    $('.photo-thumbnail').removeClass('active');
    $(`.photo-thumbnail[data-index="${currentIndex}"]`).addClass('active');
    
    const activeThumbnail = $(`.photo-thumbnail[data-index="${currentIndex}"]`)[0];
    if (activeThumbnail) {
        activeThumbnail.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });
    }
}

function updatePhotoCounter() {
    if (!currentPhotoPreview) return;
    
    const { currentIndex, totalPhotos } = currentPhotoPreview;
    $('#photo-counter').text(`${currentIndex + 1} de ${totalPhotos}`);
}

function updateNavigationButtons() {
    if (!currentPhotoPreview) return;
    
    const { currentIndex, totalPhotos } = currentPhotoPreview;
    
    if (currentIndex === 0) {
        $('#prev-photo').addClass('disabled');
    } else {
        $('#prev-photo').removeClass('disabled');
    }
    
    if (currentIndex === totalPhotos - 1) {
        $('#next-photo').addClass('disabled');
    } else {
        $('#next-photo').removeClass('disabled');
    }
}

function setupPhotoPreviewEvents() {
    $('#prev-photo').off('click').on('click', function() {
        if (!currentPhotoPreview || $(this).hasClass('disabled')) return;
        
        currentPhotoPreview.currentIndex--;
        updatePhotoCounter();
        loadPhotoForPreview();
    });
    
    $('#next-photo').off('click').on('click', function() {
        if (!currentPhotoPreview || $(this).hasClass('disabled')) return;
        
        currentPhotoPreview.currentIndex++;
        updatePhotoCounter();
        loadPhotoForPreview();
    });
    
    $('#download-photo').off('click').on('click', async function() {
        if (!currentPhotoPreview) return;
        
        const { photoIds, currentIndex } = currentPhotoPreview;
        const currentId = photoIds[currentIndex];
        
        if (!currentId) return;
        
        try {
            const base64String = await getImageFromDB(currentId);
            if (base64String) {
                const link = document.createElement('a');
                link.href = base64String;
                link.download = `foto_${currentId}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Foto descargada',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } catch (error) {
            console.error("Error descargando foto:", error);
            Swal.fire('Error', 'No se pudo descargar la foto.', 'error');
        }
    });
    
    $('#delete-photo').off('click').on('click', async function() {
        if (!currentPhotoPreview) return;
        
        const { previewId, photoIds, currentIndex } = currentPhotoPreview;
        const currentId = photoIds[currentIndex];
        
        if (!currentId) return;
        
        Swal.fire({
            title: '¿Eliminar esta foto?',
            text: "Esta acción no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef5350',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await deleteImageFromDB(currentId);
                    
                    if (selectedFiles[previewId]) {
                        selectedFiles[previewId] = selectedFiles[previewId].filter(id => id !== currentId);
                    }
                    
                    currentPhotoPreview.photoIds = selectedFiles[previewId] || [];
                    currentPhotoPreview.totalPhotos = currentPhotoPreview.photoIds.length;
                    
                    if (currentPhotoPreview.totalPhotos === 0) {
                        const photoPreviewModal = bootstrap.Modal.getInstance(document.getElementById('photoPreviewModal'));
                        if (photoPreviewModal) {
                            photoPreviewModal.hide();
                        }
                    } else {
                        if (currentPhotoPreview.currentIndex >= currentPhotoPreview.totalPhotos) {
                            currentPhotoPreview.currentIndex = currentPhotoPreview.totalPhotos - 1;
                        }
                        
                        updatePhotoCounter();
                        loadPhotoForPreview();
                        generatePhotoThumbnails();
                    }
                    
                    await renderFotosPreview(previewId);
                    saveSession();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Foto eliminada',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    
                } catch (error) {
                    console.error("Error eliminando foto:", error);
                    Swal.fire('Error', 'No se pudo eliminar la foto.', 'error');
                }
            }
        });
    });
    
    $('#photoPreviewModal').off('shown.bs.modal').on('shown.bs.modal', function() {
        $(document).on('keydown.photoPreview', function(e) {
            if (!currentPhotoPreview) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    if (currentPhotoPreview.currentIndex > 0) {
                        e.preventDefault();
                        currentPhotoPreview.currentIndex--;
                        updatePhotoCounter();
                        loadPhotoForPreview();
                    }
                    break;
                    
                case 'ArrowRight':
                    if (currentPhotoPreview.currentIndex < currentPhotoPreview.totalPhotos - 1) {
                        e.preventDefault();
                        currentPhotoPreview.currentIndex++;
                        updatePhotoCounter();
                        loadPhotoForPreview();
                    }
                    break;
                    
                case 'Escape':
                    const photoPreviewModal = bootstrap.Modal.getInstance(document.getElementById('photoPreviewModal'));
                    if (photoPreviewModal) {
                        photoPreviewModal.hide();
                    }
                    break;
            }
        });
    });
    
    $('#photoPreviewModal').off('hidden.bs.modal').on('hidden.bs.modal', function() {
        $(document).off('keydown.photoPreview');
        currentPhotoPreview = null;
        $('body').removeClass('camera-active');
        updateFloatingButtonVisibility();
    });
}

// =========================================================================
// FUNCIONES AUXILIARES
// =========================================================================

function updateFloatingButtonVisibility() {
    const $visibleUploadArea = $('.file-upload').filter(':visible');
    
    if ($visibleUploadArea.length > 0) {
        $('#btn-camara-flotante').fadeIn();
    } else {
        $('#btn-camara-flotante').fadeOut();
    }
}

function showLoadingOverlay(message = "Por favor espera un momento...", subMessage = "") {
    const overlay = document.getElementById('overlay');
    const loadingMessage = document.getElementById('loadingMessage');
    
    if (loadingMessage) {
        loadingMessage.querySelector('h4').textContent = message;
        if (subMessage) {
            loadingMessage.querySelector('p').textContent = subMessage;
            loadingMessage.querySelector('p').style.display = 'block';
        } else {
            loadingMessage.querySelector('p').style.display = 'none';
        }
    }
    
    overlay.style.display = 'flex';
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'none';
}

// =========================================================================
// FUNCIONES PARA GENERAR PDF
// =========================================================================

function compressImageForPDF(base64String, quality = 0.7) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxWidth = 800; 
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            const compressedBase64 = canvas.toDataURL('image/jpeg', quality); 
            resolve(compressedBase64);
        };
        img.onerror = () => resolve(null);
        img.src = base64String;
    });
}

const addPageFooters = (doc) => {
    const pageCount = doc.internal.getNumberOfPages();
    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Página ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 15, { align: 'right' });
    }
};

const addPhotos = async (doc, imageIds, yPosRef, pageHeight, margin) => {
    if (!imageIds || imageIds.length === 0) return yPosRef.y;
    
    let yPos = yPosRef.y + 10;
    
    const imgWidth = 160; 
    const imgHeight = 120;
    const marginX = margin; 
    const spacingX = (doc.internal.pageSize.width - margin * 2 - imgWidth * 3) / 2;
    const spacingY = imgHeight + 15;
    
    let imgCount = 0;
    
    for (const id of imageIds) {
        await new Promise(resolve => setTimeout(resolve, 0));
        const base64String = await getImageFromDB(id);
        if (!base64String) continue;
        
        const compressedBase64 = await compressImageForPDF(base64String);
        if (!compressedBase64) continue;
        
        const col = imgCount % 3;
        const row = Math.floor(imgCount / 3);
        
        let x = col * (imgWidth + spacingX) + marginX;
        let y = row * spacingY + yPos;
        
        if (y + imgHeight > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
            imgCount = 0;
            const newRow = Math.floor(imgCount / 3);
            y = newRow * spacingY + yPos;
        }
        
        doc.addImage(compressedBase64, 'JPEG', x, y, imgWidth, imgHeight);
        imgCount++;
    }
    
    const rowsUsed = Math.ceil(imgCount / 3);
    yPosRef.y = yPos + (rowsUsed * spacingY) + 20;
    
    return yPosRef.y;
};

const addSectionTitle = (doc, title, yPosRef, forceNewPage = false) => {
    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    const rectHeight = 22;
    const spacingAfter = 15;
    if (forceNewPage || (yPosRef.y + rectHeight + spacingAfter > pageHeight - margin)) {
        doc.addPage();
        yPosRef.y = margin;
    }
    doc.setFillColor(44, 62, 80); 
    doc.rect(margin, yPosRef.y, pageWidth - margin * 2, rectHeight, 'F');
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    const textY = yPosRef.y + (rectHeight / 2) + 5;
    doc.text(title, margin + 10, textY);
    doc.setTextColor(51, 51, 51);
    yPosRef.y += rectHeight + spacingAfter;
};

async function addHeaderAndComments(doc, data, yPosRef) {
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    const logoBase64 = logoBase64_Cache; 
    let textX = margin;
    const logoWidth = 30, logoHeight = 30, logoX = margin;
    const startYText = yPosRef.y + 10; 
    const lineHeight = 15;

    if (logoBase64) {
        try {
            doc.addImage(logoBase64, "PNG", logoX, yPosRef.y, logoWidth, logoHeight);
            textX = logoX + logoWidth + 10;
        } catch (e) { console.error("Error al añadir el logo:", e); }
    }
    
    doc.setFontSize(16); 
    doc.setFont('helvetica', 'bold');
    doc.text('Reporte de Actividades', textX, startYText);
    
    doc.setFontSize(11); 
    doc.setFont('helvetica', 'normal');
    
    let fechaFormateada = data.fecha || 'N/A';
    if (data.fecha) {
        try {
            const fechaObj = new Date(data.fecha + 'T00:00:00'); 
            fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            fechaFormateada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);
        } catch(e) { fechaFormateada = data.fecha; }
    }
    doc.text(`Fecha: ${fechaFormateada}`, textX, startYText + lineHeight);
    
    // PROYECTO Y UBICACIÓN EN LA MISMA LÍNEA
    const proyecto = data.proyecto || 'N/A';
    const ubicacion = data.ubicacion || 'No especificada';
    doc.text(`Proyecto: ${proyecto}, Ubicación: ${ubicacion}`, textX, startYText + (lineHeight * 2));
    
    yPosRef.y += logoHeight + 20;

    // Descripción
    addSectionTitle(doc, 'Descripción de la Actividad', yPosRef, false);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    
    let descripcion = data.descripcion || '';
    if (descripcion) {
        const textLines = doc.splitTextToSize(descripcion, pageWidth - margin * 2);
        doc.text(textLines, margin, yPosRef.y);
        yPosRef.y += textLines.length * 14 + 15;
    }
    
    doc.setDrawColor(221, 221, 221);
    doc.line(margin, yPosRef.y, pageWidth - margin, yPosRef.y);
    yPosRef.y += 15;
}


async function generatePDFContent(doc, data, yPosRef) {
    const pageHeight = doc.internal.pageSize.height;
    const margin = 40;

    // Evidencia Fotográfica
    const previewId = 'preview-actividad';
    if (data.fotos && data.fotos[previewId] && data.fotos[previewId].length > 0) {
        addSectionTitle(doc, 'Evidencia Fotográfica', yPosRef, false);
        await addPhotos(doc, data.fotos[previewId], yPosRef, pageHeight, margin);
    }
}

function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function generatePDF() {
    Swal.close();
    showLoadingOverlay("Procesando...", "Generando documento PDF...");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'letter');
    const dataString = localStorage.getItem(SESSION_KEY);
    
    if (!dataString) {
        hideLoadingOverlay();
        Swal.fire('Error', 'No se encontraron datos de sesión.', 'error'); 
        return;
    }
    const data = JSON.parse(dataString);

    // Validar campos requeridos
    if (!data.fecha || !data.proyecto || !data.ubicacion || !data.descripcion) {
        hideLoadingOverlay();
        Swal.fire('Campos Incompletos', 'Debe completar todos los campos requeridos.', 'warning');
        return;
    }

    let fechaFormateada = 'dd-mm-aaaa';
    if (data.fecha) { 
        const parts = data.fecha.split('-'); 
        if (parts.length === 3) fechaFormateada = `${parts[2]}-${parts[1]}-${parts[0]}`; 
    }
    const proyecto = data.proyecto || 'Proyecto';
    const ubicacion = data.ubicacion || 'No especificada';
    
    // NOMBRE DEL ARCHIVO CON UBICACIÓN
    const nombreArchivoFinal = `${fechaFormateada} - Reporte de Actividades - ${proyecto} - ${ubicacion}.pdf`;
    
    const margin = 40;
    let yPosRef = { y: margin }; 

    try {
        showLoadingOverlay("Generando PDF", "Escribiendo contenido...");
        await addHeaderAndComments(doc, data, yPosRef);
        await generatePDFContent(doc, data, yPosRef);
        addPageFooters(doc); 
        
        const pdfBlob = doc.output('blob');
        const pdfBase64 = await blobToBase64(pdfBlob);
        
        const reporteParaGuardar = {
            proyecto: proyecto,
            ubicacion: ubicacion,
            fecha: data.fecha || fechaFormateada,
            nombreArchivo: nombreArchivoFinal,
            pdfBase64: pdfBase64.split(',')[1],
            descripcion: data.descripcion,
            tipo: 'actividad'
        };

        // Guardamos en Pendientes
        await guardarReportePendiente(reporteParaGuardar);
        
        hideLoadingOverlay();

        Swal.fire({
            title: '¡Reporte Guardado!',
            html: `
                <div class="text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p>El reporte está listo y se enviará una vez se sincronice.</p>
                    <p class="small text-muted">Tu progreso actual sigue aquí por si necesitas editar algo más.</p>
                </div>
            `,
            icon: 'success',
            allowOutsideClick: false,
            showCloseButton: true,
            
            confirmButtonText: '<i class="fas fa-list-ul me-2"></i> Ver Pendientes',
            confirmButtonColor: '#2c3e50',
            
            showCancelButton: true,
            cancelButtonText: '<i class="fas fa-plus me-2"></i> Nuevo Reporte',
            cancelButtonColor: '#3498db'
        }).then((result) => {
            if (result.isConfirmed) {
                // Opción: Ver Pendientes
                renderizarModalPendientes();
                $('#modalSync').modal('show');
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                // Opción: Nuevo Reporte (Con confirmación de borrado)
                confirmarNuevoReporte();
            }
        });

    } catch (error) {
        hideLoadingOverlay();
        console.error("Error al guardar PDF:", error);
        Swal.fire('Error', 'No se pudo guardar el reporte localmente: ' + error.message, 'error');
    }
}

function confirmarNuevoReporte() {
    Swal.fire({
        title: '¿Iniciar nuevo reporte?',
        text: "Esto borrará todo el formulario actual. Si ya generaste el PDF, es seguro continuar.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, empezar de cero',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#2ecc71',
        cancelButtonColor: '#7f8c8d'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await clearSession();
            window.location.reload();
        }
    });
}

// =========================================================================
// FUNCIONES DE SINCRONIZACIÓN
// =========================================================================

function guardarReportePendiente(datosReporte) {
    return new Promise((resolve, reject) => {
        if (!db) return reject('DB no inicializada');
        const transaction = db.transaction([STORE_PENDING], 'readwrite');
        const store = transaction.objectStore(STORE_PENDING);
        
        datosReporte.creadoEn = new Date().getTime();
        datosReporte.estado = 'pendiente';
        
        const request = store.add(datosReporte);
        
        request.onsuccess = () => {
            actualizarContadorPendientes();
            resolve();
        };
        request.onerror = (e) => reject(e.target.error);
    });
}

function marcarComoSincronizado(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_PENDING], 'readwrite');
        const store = transaction.objectStore(STORE_PENDING);
        
        const getRequest = store.get(id);
        
        getRequest.onsuccess = () => {
            const data = getRequest.result;
            if (data) {
                data.estado = 'sincronizado';
                data.sincronizadoEn = new Date().getTime();
                store.put(data);
                actualizarContadorPendientes();
                resolve();
            } else {
                resolve();
            }
        };
        getRequest.onerror = (e) => reject(e);
    });
}

function obtenerPendientes() {
    return new Promise((resolve, reject) => {
        if (!db) return resolve([]);
        const transaction = db.transaction([STORE_PENDING], 'readonly');
        const store = transaction.objectStore(STORE_PENDING);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject([]);
    });
}

function borrarPendiente(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_PENDING], 'readwrite');
        const store = transaction.objectStore(STORE_PENDING);
        const request = store.delete(id);
        request.onsuccess = () => {
            actualizarContadorPendientes();
            resolve();
        };
        request.onerror = (e) => reject(e);
    });
}

async function actualizarContadorPendientes() {
    try {
        const todos = await obtenerPendientes();
        const pendientes = todos.filter(r => r.estado === 'pendiente').length;
        
        const $btn = $('#btn-sync-manager');
        const $badge = $('#badge-pendientes');
        
        $badge.text(pendientes);
        
        if (pendientes > 0) {
            $btn.fadeIn();
        } else {
            if(todos.length > 0) $btn.fadeIn(); else $btn.fadeOut();
        }
    } catch (e) {
        console.error("Error contando pendientes", e);
    }
}

// =========================================================
//  LÓGICA ACTUALIZADA DE GESTIÓN DE ENVÍOS
// =========================================================

async function renderizarModalPendientes() {
    const todosLosRegistros = await obtenerPendientes();
    
    const pendientes = todosLosRegistros.filter(r => r.estado === 'pendiente').sort((a, b) => b.creadoEn - a.creadoEn);
    const sincronizados = todosLosRegistros.filter(r => r.estado === 'sincronizado').sort((a, b) => b.sincronizadoEn - a.sincronizadoEn);

    const $listaPendientes = $('#lista-pendientes');
    const $listaSincronizados = $('#lista-sincronizados');
    const $badgeTab = $('#badge-tab-pendientes');

    $listaPendientes.empty();
    $listaSincronizados.empty();
    
    // Resetear
    $('#check-all-pendientes').prop('checked', false);
    $('#check-all-sincronizados').prop('checked', false);
    actualizarBotonesSeleccion();

    if (pendientes.length > 0) {
        $badgeTab.text(pendientes.length).show();
    } else {
        $badgeTab.hide();
    }

    // --- RENDERIZAR PENDIENTES ---
    if (pendientes.length === 0) {
        $listaPendientes.html('<div class="text-center p-4 text-muted small">No hay reportes pendientes.</div>');
    } else {
        pendientes.forEach(reporte => {
            const fechaObj = new Date(reporte.creadoEn);
            const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const html = `
                <div class="list-group-item d-flex align-items-center" id="row-reporte-${reporte.id}">
                    <div class="me-2 checkbox-container">
                        <input class="form-check-input check-pendiente fs-5" type="checkbox" value="${reporte.id}">
                    </div>
                    
                    <div class="flex-grow-1 overflow-hidden me-2">
                        <h6 class="mb-0 fw-bold text-dark text-truncate">${reporte.proyecto} - ${reporte.ubicacion}</h6>
                        <small class="text-muted d-block"><i class="far fa-calendar-alt me-1"></i>${fechaStr}</small>
                        <span class="badge bg-warning text-dark rounded-pill mt-1" style="font-size: 0.7rem;">Pendiente</span>
                    </div>

                    <div class="status-wrapper ms-auto" style="display:none;"></div>

                    <div class="action-buttons ms-auto d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary btn-ver-pdf" data-id="${reporte.id}" title="Ver PDF">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success btn-share-pdf" data-id="${reporte.id}" title="Compartir">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete-registro" data-id="${reporte.id}" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            $listaPendientes.append(html);
        });
    }

    // --- RENDERIZAR SINCRONIZADOS ---
    if (sincronizados.length === 0) {
        $listaSincronizados.html('<div class="text-center p-4 text-muted small">Historial vacío.</div>');
    } else {
        sincronizados.forEach(reporte => {
            const fechaObj = new Date(reporte.sincronizadoEn || reporte.creadoEn);
            const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const html = `
                <div class="list-group-item d-flex align-items-center" id="row-reporte-${reporte.id}">
                    <div class="me-2 checkbox-container">
                        <input class="form-check-input check-sincronizado fs-5" type="checkbox" value="${reporte.id}">
                    </div>
                    
                    <div class="flex-grow-1 overflow-hidden me-2">
                        <h6 class="mb-0 text-dark text-truncate">${reporte.proyecto} - ${reporte.ubicacion}</h6>
                        <small class="text-success d-block"><i class="fas fa-check-double me-1"></i>${fechaStr}</small>
                    </div>

                    <div class="status-wrapper ms-auto" style="display:none;"></div>

                    <div class="action-buttons ms-auto d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary btn-ver-pdf" data-id="${reporte.id}" title="Ver PDF">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success btn-share-pdf" data-id="${reporte.id}" title="Compartir">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete-registro" data-id="${reporte.id}" title="Eliminar Historial">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            $listaSincronizados.append(html);
        });
    }
}

function actualizarBotonesSeleccion() {
    const pendSeleccionados = $('.check-pendiente:checked').length;
    const sincSeleccionados = $('.check-sincronizado:checked').length;

    $('#btn-sincronizar-seleccionados').prop('disabled', pendSeleccionados === 0);
    $('#btn-delete-pendientes-sel').prop('disabled', pendSeleccionados === 0);

    $('#btn-resync-seleccion').prop('disabled', sincSeleccionados === 0);
    $('#btn-delete-sincronizados-sel').prop('disabled', sincSeleccionados === 0);
}

async function procesarColaDeEnvio(listaDeReportes) {
    if (listaDeReportes.length === 0) return;

    // BLOQUEO TOTAL
    window.isSyncing = true; 
    $('.action-buttons').attr('style', 'display: none !important');
    $('.checkbox-container').css('visibility', 'hidden');
    $('#check-all-pendientes, #check-all-sincronizados').css('visibility', 'hidden');
    $('label[for="check-all-pendientes"], label[for="check-all-sincronizados"]').css('visibility', 'hidden');
    $('#modalSync .btn-close').hide();
    $('#btn-sincronizar-seleccionados, #btn-resync-seleccion').hide();
    $('#btn-delete-pendientes-sel, #btn-delete-sincronizados-sel').hide();
    $('.btn').addClass('disabled');

    let errores = 0;
    let exitos = 0;
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby8NHjUecQcWJ3ttLxKC5f1s8jx_KS_1Q8TYklKq7KoH4tiBIYLBFM853fCASJSerwv5Q/exec";

    for (const reporte of listaDeReportes) {
        const $row = $(`#row-reporte-${reporte.id}`);
        const $status = $row.find('.status-wrapper');
        
        $row.find('.action-buttons').hide();
        
        $status.html('<span class="badge bg-info text-dark"><i class="fas fa-spinner fa-spin"></i> Subiendo...</span>').fadeIn();
        
        if ($row.length) {
            $row[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        try {
            const requestData = {
                proyecto: reporte.proyecto,
                ubicacion: reporte.ubicacion,
                fecha: reporte.fecha,
                nombreArchivo: reporte.nombreArchivo,
                pdfBase64: reporte.pdfBase64,
                descripcion: reporte.descripcion,
                tipo: 'actividad'
            };

            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            await marcarComoSincronizado(reporte.id);
            
            $status.html('<span class="badge bg-success"><i class="fas fa-check"></i> Enviado</span>');
            $row.addClass('list-group-item-success');
            exitos++;

        } catch (error) {
            console.error("Error subiendo reporte:", error);
            $status.html('<span class="badge bg-danger"><i class="fas fa-times"></i> Error</span>');
            errores++;
        }
        
        await new Promise(r => setTimeout(r, 500));
    }

    if (errores === 0) {
        Swal.fire({
            icon: 'success',
            title: 'Proceso Completado',
            text: `Se enviaron ${exitos} reportes correctamente.`,
            timer: 1500,
            showConfirmButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            finishSyncProcess();
        });
    } else {
        Swal.fire({
            title: 'Proceso Finalizado', 
            text: `Enviados: ${exitos}. Errores: ${errores}.`, 
            icon: 'warning',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            finishSyncProcess();
        });
    }
}

async function finishSyncProcess() {
    await renderizarModalPendientes(); 
    $('#check-all-pendientes, #check-all-sincronizados').css('visibility', 'visible');
    $('label[for="check-all-pendientes"], label[for="check-all-sincronizados"]').css('visibility', 'visible');
    $('#modalSync .btn-close').fadeIn();
    $('#btn-sincronizar-seleccionados, #btn-resync-seleccion').fadeIn();
    $('#btn-delete-pendientes-sel, #btn-delete-sincronizados-sel').fadeIn();
    $('.btn').removeClass('disabled');
    actualizarBotonesSeleccion();
    window.isSyncing = false;
}

$('#modalSync').on('hide.bs.modal', function (e) {
    if (window.isSyncing) {
        e.preventDefault(); 
        return false;
    }
});

async function moverAPendientesYEnviar(ids) {
    if (!db) return;
    
    const $btn = $('#btn-resync-seleccion');
    const originalText = '<i class="fas fa-redo me-2"></i> Volver a Sincronizar Seleccionados';
    
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Moviendo...');

    const transaction = db.transaction([STORE_PENDING], 'readwrite');
    const store = transaction.objectStore(STORE_PENDING);

    for (const id of ids) {
        await new Promise((resolve) => {
            const req = store.get(id);
            req.onsuccess = () => {
                const data = req.result;
                if (data) {
                    data.estado = 'pendiente';
                    data.creadoEn = new Date().getTime();
                    store.put(data);
                }
                resolve();
            };
        });
    }

    $btn.prop('disabled', false).html(originalText);
    $('.check-sincronizado').prop('checked', false);
    actualizarBotonesSeleccion();

    await renderizarModalPendientes(); 
    
    const tabPendientes = new bootstrap.Tab(document.getElementById('tab-pendientes'));
    tabPendientes.show();
    
    const todos = await obtenerPendientes();
    const listaParaEnviar = todos.filter(r => ids.includes(r.id));

    await procesarColaDeEnvio(listaParaEnviar);
}

async function eliminarRegistrosSeleccionados(claseCheckbox) {
    const ids = [];
    $(`.${claseCheckbox}:checked`).each(function() {
        ids.push(parseInt($(this).val()));
    });

    if (ids.length === 0) return;

    Swal.fire({
        title: '¿Eliminar seleccionados?',
        text: `Se eliminarán ${ids.length} registros permanentemente.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then(async (result) => {
        if (result.isConfirmed) {
            for (const id of ids) {
                await borrarPendiente(id);
            }
            renderizarModalPendientes();
            Swal.fire('Eliminados', 'Los registros han sido borrados.', 'success');
        }
    });
}

// =========================================================
//  LÓGICA PARA VISTA PREVIA DE PDF
// =========================================================

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

$(document).on('click', '.btn-ver-pdf', async function(e) {
    e.stopPropagation();
    const id = parseInt($(this).data('id'));

    if (!db) {
        Swal.fire('Error', 'Base de datos no inicializada', 'error');
        return;
    }

    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

    try {
        const transaction = db.transaction([STORE_PENDING], 'readonly');
        const store = transaction.objectStore(STORE_PENDING);
        const request = store.get(id);

        request.onsuccess = async function() {
            const data = request.result;
            if (data && data.pdfBase64) {
                
                const container = document.getElementById('pdf-render-container');
                container.innerHTML = ''; 
                
                $('#modalPdfPreview').modal('show');

                const pdfData = atob(data.pdfBase64);
                
                try {
                    const loadingTask = pdfjsLib.getDocument({data: pdfData});
                    const pdf = await loadingTask.promise;

                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        
                        const viewportOriginal = page.getViewport({scale: 1});
                        const containerWidth = container.clientWidth || window.innerWidth;
                        const desiredWidth = containerWidth - 20; 
                        const visualScale = desiredWidth / viewportOriginal.width;
                        const pixelRatio = (window.devicePixelRatio || 1) * 1.5; 
                        const renderScale = visualScale * pixelRatio;

                        const viewport = page.getViewport({scale: renderScale});

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');

                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        canvas.style.width = "100%"; 
                        canvas.style.maxWidth = `${desiredWidth}px`;
                        canvas.style.height = "auto"; 
                        canvas.style.marginBottom = "20px";
                        canvas.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
                        canvas.style.borderRadius = "4px";

                        container.appendChild(canvas);

                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        await page.render(renderContext).promise;
                    }

                } catch (renderError) {
                    console.error(renderError);
                    Swal.fire('Error Visualización', 'No se pudo renderizar el PDF.', 'error');
                }

            } else {
                Swal.fire('Error', 'No se encontró el PDF.', 'error');
            }
            btn.html(originalHtml).prop('disabled', false);
        };

        request.onerror = function() {
            Swal.fire('Error', 'Error al leer DB.', 'error');
            btn.html(originalHtml).prop('disabled', false);
        };

    } catch (error) {
        console.error(error);
        btn.html(originalHtml).prop('disabled', false);
    }
});

$('#modalPdfPreview').on('hidden.bs.modal', function () {
    document.getElementById('pdf-render-container').innerHTML = '';
});

// =========================================================
//  LÓGICA DE COMPARTIR PDF
// =========================================================

function base64ToBlob(base64, type = 'application/pdf') {
    const binStr = atob(base64);
    const len = binStr.length;
    const arr = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        arr[i] = binStr.charCodeAt(i);
    }
    return new Blob([arr], { type: type });
}

$(document).on('click', '.btn-share-pdf', async function(e) {
    e.stopPropagation();
    const id = parseInt($(this).data('id'));

    if (!db) return;

    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

    try {
        const transaction = db.transaction([STORE_PENDING], 'readonly');
        const store = transaction.objectStore(STORE_PENDING);
        const request = store.get(id);

        request.onsuccess = async function() {
            const data = request.result;
            if (data && data.pdfBase64) {
                
                const blob = base64ToBlob(data.pdfBase64, 'application/pdf');
                const file = new File([blob], data.nombreArchivo || "reporte_actividad.pdf", { type: "application/pdf" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'Reporte de Actividades',
                            text: `Adjunto reporte de actividad - ${data.proyecto} - ${data.ubicacion}`
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Error al compartir:', error);
                            Swal.fire('Error', 'No se pudo compartir.', 'error');
                        }
                    }
                } else {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = data.nombreArchivo;
                    link.click();
                    Swal.fire('Descargando', 'Tu dispositivo no soporta compartir directo, se descargará el archivo.', 'info');
                }
            }
            btn.html(originalHtml).prop('disabled', false);
        };
    } catch (error) {
        console.error(error);
        btn.html(originalHtml).prop('disabled', false);
    }
});

// =========================================================
//  CONTROL DE VISIBILIDAD DEL BOTÓN FLOTANTE (CÁMARA)
// =========================================================

$('#modalSync, #modalPdfPreview').on('show.bs.modal', function () {
    $('#btn-camara-flotante').hide();
});

$('#modalSync, #modalPdfPreview').on('hidden.bs.modal', function () {
    if ($('.modal.show').length > 0) {
        $('#btn-camara-flotante').hide();
    } else {
        updateFloatingButtonVisibility();
    }
});

// =========================================================================
// INICIALIZACIÓN Y EVENTOS
// =========================================================================

document.addEventListener('DOMContentLoaded', async function() {
    
    try {
        // 1. Carga inicial de recursos y DB
        loadLogoCache();
        await initDB();
        
        // 2. Referencias a elementos del DOM
        $form = $('#form-actividades');
        
        $selectProyecto = $('#select-proyecto');
        $fechaInput = $('#fecha-actividad');
        $descripcionInput = $('#descripcion-actividad');
        $selectUbicacion = $('#select-ubicacion');
        
        // 3. Verificar si hay una sesión guardada a medias
        await checkForSavedSession();
        
        // 4. Actualizar el contador rojo del botón flotante
        await actualizarContadorPendientes();

        // 5. Lógica para abrir el modal automáticamente tras guardar un reporte
        if (sessionStorage.getItem('openSyncModal') === 'true') {
            sessionStorage.removeItem('openSyncModal');
            setTimeout(() => {
                renderizarModalPendientes();
                $('#modalSync').modal('show');
            }, 800);
        }

    } catch (error) {
        console.error("Error en inicialización:", error);
    }
    
    // 6. Poner fecha de hoy si está vacía
    if ($('#fecha-actividad').val() === '') {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        $('#fecha-actividad').val(`${yyyy}-${mm}-${dd}`);
    }
    
    // =========================================================================
    // EVENTOS DE FORMULARIO
    // =========================================================================
    
    $(document).on('click', '#btn-enviar-actividad', async function(e) {
        e.preventDefault();
        
        // Validar campos
        if (!$fechaInput.val()) {
            Swal.fire('Campo Requerido', 'Debe seleccionar una fecha.', 'warning');
            return;
        }
        
        if (!$selectProyecto.val()) {
            Swal.fire('Campo Requerido', 'Debe seleccionar un proyecto.', 'warning');
            return;
        }
        
        if (!$selectUbicacion.val()) {
            Swal.fire('Campo Requerido', 'Debe seleccionar una ubicación.', 'warning');
            return;
        }
        
        if (!$descripcionInput.val().trim()) {
            Swal.fire('Campo Requerido', 'Debe ingresar una descripción de la actividad.', 'warning');
            return;
        }
        
        // Validar que haya al menos una foto
        const previewId = 'preview-actividad';
        if (!selectedFiles[previewId] || selectedFiles[previewId].length === 0) {
            Swal.fire('Foto Requerida', 'Debe tomar al menos una fotografía como evidencia.', 'warning');
            return;
        }
        
        await generatePDF();
    });
    
    // =========================================================================
    // EVENTOS DE CÁMARA
    // =========================================================================
    
    // Botón flotante de cámara
    $('#btn-camara-flotante').on('click', function(e) {
        e.preventDefault(); 
        e.stopPropagation();
        openCamera('preview-actividad');
    });
    
    $('#capture-btn').on('click', capturePhoto);
    $('#flash-toggle').on('click', toggleFlash);
    $('#zoom-in').on('click', zoomIn);
    $('#zoom-out').on('click', zoomOut);
    
    // Auto-save
    $form.on('change input', '.auto-save', saveSession);
    
    // Evento para actualizar ubicaciones cuando cambie el proyecto
    $selectProyecto.on('change', function() {
        actualizarUbicaciones();
    });
    
    // =========================================================================
    // EVENTOS: GESTOR DE ENVÍOS (OFFLINE / SYNC)
    // =========================================================================

    // 1. Abrir el Modal con el Botón Flotante
    $('#btn-sync-manager').on('click', function() {
        renderizarModalPendientes();
        $('#modalSync').modal('show');
    });

    // 2. Checkboxes "Seleccionar Todos"
    $(document).on('change', '#check-all-pendientes', function() {
        $('.check-pendiente').prop('checked', $(this).is(':checked'));
        actualizarBotonesSeleccion();
    });

    $(document).on('change', '#check-all-sincronizados', function() {
        $('.check-sincronizado').prop('checked', $(this).is(':checked'));
        actualizarBotonesSeleccion();
    });

    // 3. Checkboxes individuales
    $(document).on('change', '.check-pendiente, .check-sincronizado', function() {
        actualizarBotonesSeleccion();
    });

    // 4. Botón Sincronizar Selección
    $('#btn-sincronizar-seleccionados').on('click', async function() {
        const ids = [];
        $('.check-pendiente:checked').each(function() { ids.push(parseInt($(this).val())); });
        
        if (ids.length === 0) return;

        const todos = await obtenerPendientes();
        const listaEnviar = todos.filter(r => ids.includes(r.id));
        
        await procesarColaDeEnvio(listaEnviar);
    });

    // 5. Botón Volver a Sincronizar Selección
    $('#btn-resync-seleccion').on('click', function() {
        const ids = [];
        $('.check-sincronizado:checked').each(function() { ids.push(parseInt($(this).val())); });
        
        if (ids.length === 0) return;
        
        moverAPendientesYEnviar(ids);
    });

    // 6. Botones Eliminar Selección
    $('#btn-delete-pendientes-sel').on('click', function() {
        eliminarRegistrosSeleccionados('check-pendiente');
    });

    $('#btn-delete-sincronizados-sel').on('click', function() {
        eliminarRegistrosSeleccionados('check-sincronizado');
    });
    
    // 7. Botones eliminar individuales
    $(document).on('click', '.btn-delete-registro', function() {
        const id = parseInt($(this).data('id'));
        
        Swal.fire({
            title: '¿Eliminar registro?',
            text: "Esta acción borrará el reporte de este dispositivo permanentemente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                await borrarPendiente(id);
                if ($('#modalSync').hasClass('show')) {
                    renderizarModalPendientes();
                }
                Swal.fire('Eliminado', 'El registro ha sido eliminado.', 'success');
            }
        });
    });

    // 8. Clic en toda la fila para marcar checkbox
    $(document).on('click', '.list-group-item', function(e) {
        if ($(e.target).is('input[type="checkbox"]') || 
            $(e.target).closest('button').length > 0 || 
            $(e.target).closest('.badge').length > 0) {
            return;
        }

        const $checkbox = $(this).find('input[type="checkbox"]');
        
        if ($checkbox.length > 0) {
            $checkbox.prop('checked', !$checkbox.prop('checked'));
            $checkbox.trigger('change');
        }
    });

});

</script>
</body>
</html>